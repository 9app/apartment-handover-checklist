<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checklist Ho√†n Ch·ªânh B√†n Giao CƒÉn H·ªô (c√≥ CƒÉn C·ª© Ph√°p L√Ω) - Golden City An Giang</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        details > summary {
            list-style: none;
        }
        details > summary::-webkit-details-marker {
            display: none;
        }
        details[open] summary .arrow {
            transform: rotate(90deg);
        }
        .checklist-item {
            transition: all 0.2s ease-in-out;
        }
        .checklist-item.checked {
            text-decoration: line-through;
            color: #6b7280;
        }
        .checklist-item.checked .note, .checklist-item.checked .media-list-title {
            text-decoration: none;
            color: #6b7280;
        }
        .sticky-progress {
            position: -webkit-sticky;
            position: sticky;
            top: 0;
            z-index: 50;
        }
        .action-button {
            transition: all 0.2s ease-in-out;
        }
        .action-button:hover {
            transform: scale(1.1);
        }
        .thumbnail-container .group:hover .delete-btn {
            opacity: 1;
        }
        .nav-button:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        .gallery-thumbnail.active {
            border-color: #3b82f6; /* Tailwind's blue-500 */
        }
        .note ul {
            margin-top: 0.5rem;
        }
        .note strong {
            color: #1f2937;
        }
        .legal-ref {
            display: block;
            margin-top: 8px;
            font-style: italic;
            color: #4b5563;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="container mx-auto max-w-4xl p-4 sm:p-6 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-2xl sm:text-3xl font-bold text-gray-800">CHECKLIST HO√ÄN CH·ªàNH B√ÄN GIAO CƒÇN H·ªò T3.0206A</h1>
            <p class="text-lg text-gray-600 mt-2">D·ª± √°n Nh√† ·ªü x√£ h·ªôi Golden City An Giang</p>
        </header>

        <div class="bg-white rounded-xl shadow-lg p-6 mb-6 sticky-progress">
            <div class="flex justify-between items-center mb-4">
                 <h2 class="text-lg font-semibold text-gray-700">Ti·∫øn ƒë·ªô ho√†n th√†nh</h2>
                 <span id="progress-text" class="font-bold text-blue-600">0%</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2.5">
                <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
            </div>
            <div class="flex justify-end mt-4">
                 <button onclick="printChecklist()" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg inline-flex items-center text-sm">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path></svg>
                    <span>In Checklist</span>
                </button>
            </div>
        </div>

        <div id="checklist-container" class="space-y-4">
            <!-- Checklist content will be generated by JavaScript -->
        </div>
    </div>
    
    <!-- Gemini Modal -->
    <div id="gemini-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden">
      <div class="relative top-20 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl leading-6 font-bold text-gray-900">‚ú® So·∫°n th·∫£o VƒÉn b·∫£n v·ªõi Gemini AI</h3>
                <button onclick="closeModal('gemini-modal')" class="text-gray-400 hover:text-gray-600 text-3xl font-bold">&times;</button>
            </div>
          <div class="mt-2 px-7 py-3 text-left">
            <p class="text-sm text-gray-600 mb-4">Gemini s·∫Ω gi√∫p b·∫°n so·∫°n th·∫£o m·ªôt vƒÉn b·∫£n/email trang tr·ªçng d·ª±a tr√™n c√°c v·∫•n ƒë·ªÅ b·∫°n ƒë√£ ph√°t hi·ªán. Vui l√≤ng ch·ªçn c√°c n·ªôi dung c·∫ßn ƒë∆∞a v√†o vƒÉn b·∫£n:</p>
            <div id="issues-list" class="space-y-2 mb-4"></div>
            <textarea id="custom-issue" class="w-full h-20 p-2 border rounded-md" placeholder="Th√™m c√°c v·∫•n ƒë·ªÅ kh√°c ho·∫∑c y√™u c·∫ßu c·ª• th·ªÉ c·ªßa b·∫°n ·ªü ƒë√¢y..."></textarea>
            <div id="gemini-result-container" class="mt-4 hidden">
                 <h4 class="font-semibold text-gray-800 mb-2">VƒÉn b·∫£n do Gemini ƒë·ªÅ xu·∫•t:</h4>
                 <div class="w-full p-3 h-64 overflow-y-auto bg-gray-50 rounded-md border text-sm text-gray-800" id="gemini-result"></div>
                 <button onclick="copyToClipboard()" class="mt-2 bg-blue-100 text-blue-700 font-semibold py-1 px-3 rounded-lg text-xs">Sao ch√©p n·ªôi dung</button>
            </div>
             <div id="gemini-loader" class="mt-4 hidden text-center"><p>Gemini ƒëang suy nghƒ©... ‚ú®</p></div>
          </div>
          <div class="items-center px-4 py-3">
            <button id="generate-btn" onclick="generateEmail()" class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-300">T·∫°o VƒÉn b·∫£n</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Camera Modal -->
    <div id="camera-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full z-50 hidden">
      <div class="relative top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 p-5 border w-full max-w-lg shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl leading-6 font-bold text-gray-900">üì∏ Ghi nh·∫≠n b·∫±ng ch·ª©ng</h3>
            <button onclick="closeCamera()" class="text-gray-400 hover:text-gray-600 text-3xl font-bold">&times;</button>
          </div>
          <div class="mt-2 relative">
            <video id="camera-stream" class="w-full h-auto bg-black rounded-md" autoplay playsinline></video>
            <canvas id="camera-canvas" class="hidden"></canvas>
            <div id="timer" class="absolute top-2 right-2 bg-red-600 text-white text-xs font-mono px-2 py-1 rounded-full hidden">00:00</div>
          </div>
          <div class="flex items-center justify-center space-x-4 px-4 py-3">
            <button id="capture-btn" onclick="capturePhoto()" class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md shadow-sm hover:bg-blue-600">Ch·ª•p ·∫£nh</button>
            <button id="record-btn" onclick="toggleRecording()" class="px-4 py-2 bg-red-500 text-white text-base font-medium rounded-md shadow-sm hover:bg-red-600">B·∫Øt ƒë·∫ßu Quay</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Image Preview Modal -->
    <div id="image-preview-modal" class="fixed inset-0 bg-black bg-opacity-80 flex flex-col items-center justify-center z-[60] p-4 hidden">
        <div class="relative w-full max-w-4xl max-h-[80vh] flex items-center justify-center">
             <button id="prev-image-btn" onclick="navigateGallery(-1)" class="nav-button hidden absolute left-0 sm:-left-12 top-1/2 -translate-y-1/2 bg-white bg-opacity-20 hover:bg-opacity-40 text-white p-3 rounded-full transition-opacity">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
            </button>
            <div class="relative max-w-full max-h-full bg-white p-1 rounded-lg shadow-lg">
                <button onclick="closeModal('image-preview-modal')" class="absolute -top-3 -right-3 bg-white rounded-full h-8 w-8 flex items-center justify-center text-gray-700 hover:text-black z-20 text-2xl font-bold">&times;</button>
                <img id="preview-image" src="" alt="Image Preview" class="w-full h-full object-contain rounded-md hidden">
                <video id="preview-video" src="" alt="Video Preview" class="w-full h-full object-contain rounded-md hidden" controls autoplay></video>
            </div>
            <button id="next-image-btn" onclick="navigateGallery(1)" class="nav-button hidden absolute right-0 sm:-right-12 top-1/2 -translate-y-1/2 bg-white bg-opacity-20 hover:bg-opacity-40 text-white p-3 rounded-full transition-opacity">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
            </button>
        </div>
        <div id="gallery-thumbnails" class="mt-4 h-[80px] w-full max-w-4xl flex justify-center items-center gap-2 overflow-x-auto">
             <!-- Thumbnails will be populated here -->
        </div>
    </div>


    <script>
        const checklistData = [
            {
                id: 'section0',
                title: '0Ô∏è‚É£ Ki·ªÉm Tra Ph√°p L√Ω & H·ªì S∆° (QUAN TR·ªåNG NH·∫§T)',
                items: [
                    { id: '0-1', text: 'Ki·ªÉm tra ƒêi·ªÅu ki·ªán B√†n giao c·ªßa D·ª± √°n', type: 'warning', isIssue: true, 
                      note: `<strong>Y√™u c·∫ßu CƒêT cung c·∫•p (b·∫£n g·ªëc ƒë·ªÉ ƒë·ªëi chi·∫øu v√† b·∫£n photo):</strong>
                             <ul class="list-disc pl-5">
                                 <li><strong>VƒÉn b·∫£n ch·∫•p thu·∫≠n k·∫øt qu·∫£ nghi·ªám thu</strong> c·ªßa S·ªü X√¢y d·ª±ng ƒë·ªÉ ƒë∆∞a c√¥ng tr√¨nh v√†o s·ª≠ d·ª•ng.</li>
                                 <li><strong>Bi√™n b·∫£n nghi·ªám thu ho√†n th√†nh h·∫°ng m·ª•c PCCC</strong> c·ªßa C·∫£nh s√°t PCCC.</li>
                             </ul>
                             <strong>B·∫•t l·ª£i c·∫ßn tr√°nh:</strong> Tuy·ªát ƒë·ªëi kh√¥ng nh·∫≠n nh√† n·∫øu thi·∫øu c√°c vƒÉn b·∫£n tr√™n. Vi·ªác nh·∫≠n b√†n giao khi ch∆∞a ƒë·ªß ƒëi·ªÅu ki·ªán ph√°p l√Ω s·∫Ω ƒë·∫©y r·ªßi ro v·ªÅ ph√≠a b·∫°n.
                             <span class="legal-ref"><strong>CƒÉn c·ª© ph√°p l√Ω:</strong> ƒêi·ªÅu 125 Lu·∫≠t X√¢y d·ª±ng 2014; ƒêi·ªÅu 13 Lu·∫≠t Kinh doanh BƒêS 2014; ƒêi·ªÅu 7 HƒêMB.</span>`
                    },
                    { id: '0-2', text: 'ƒê·ªëi chi·∫øu H·ª£p ƒë·ªìng v√† c√°c Ph·ª• l·ª•c', type: 'info', isIssue: false,
                      note: `<strong>C·∫ßn chu·∫©n b·ªã:</strong> B·∫£n g·ªëc H·ª£p ƒë·ªìng mua b√°n (HƒêMB) v√† t·∫•t c·∫£ c√°c ph·ª• l·ª•c ƒë√£ k√Ω.<br>
                             <strong>L∆∞u √Ω ƒë·∫∑c bi·ªát:</strong> Ph·ª• l·ª•c 1 (Danh m·ª•c v·∫≠t li·ªáu) v√† Ph·ª• l·ª•c 2 (Ti·∫øn ƒë·ªô thanh to√°n) l√† c∆° s·ªü ƒë·ªÉ ki·ªÉm tra v√† ƒë·ªëi chi·∫øu.
                             <span class="legal-ref"><strong>CƒÉn c·ª© ph√°p l√Ω:</strong> ƒêi·ªÅu 1, Kho·∫£n 1e HƒêMB.</span>`
                    },
                    { id: '0-3', text: 'Ki·ªÉm tra n·ªôi dung Bi√™n b·∫£n B√†n giao', type: 'warning', isIssue: true,
                      note: `<strong>Tr∆∞·ªõc khi k√Ω, ph·∫£i ƒë·∫£m b·∫£o:</strong>
                             <ul class="list-disc pl-5">
                                 <li>Bi√™n b·∫£n ph·∫£i ghi ƒë√∫ng th√¥ng tin cƒÉn h·ªô, th√¥ng tin c·ªßa b·∫°n.</li>
                                 <li>M·ªçi sai s√≥t, l·ªói k·ªπ thu·∫≠t ph·∫£i ƒë∆∞·ª£c li·ªát k√™ chi ti·∫øt (xem c√°c m·ª•c d∆∞·ªõi).</li>
                                 <li>Ph·∫£i c√≥ cam k·∫øt v·ªÅ <strong>ng√†y th√°ng c·ª• th·ªÉ</strong> kh·∫Øc ph·ª•c cho t·ª´ng l·ªói.</li>
                             </ul>
                             <strong>B·∫•t l·ª£i c·∫ßn tr√°nh:</strong> Kh√¥ng k√Ω v√†o bi√™n b·∫£n tr·ªëng ho·∫∑c bi√™n b·∫£n ghi n·ªôi dung chung chung nh∆∞ "b√†n giao ƒë√∫ng hi·ªán tr·∫°ng". M·ªçi cam k·∫øt mi·ªáng ƒë·ªÅu kh√¥ng c√≥ gi√° tr·ªã.
                             <span class="legal-ref"><strong>CƒÉn c·ª© ph√°p l√Ω:</strong> ƒêi·ªÅu 7, Kho·∫£n 4 HƒêMB.</span>`
                    }
                ]
            },
            {
                id: 'section1',
                title: '1Ô∏è‚É£ Ki·ªÉm Tra Th·ª±c T·∫ø CƒÉn H·ªô',
                items: [
                    {
                        id: '1-1', text: 'Di·ªán t√≠ch th√¥ng th·ªßy', isIssue: true,
                        note: `<strong>Thi·∫øt b·ªã ki·ªÉm tra:</strong> th∆∞·ªõc laser, th∆∞·ªõc d√¢y.<br>
                               <strong>D·∫•u hi·ªáu:</strong> sai di·ªán t√≠ch, m√©p t∆∞·ªùng kh√¥ng vu√¥ng, chi·ªÅu d√†i ng·∫Øn h∆°n b·∫£n v·∫Ω.<br>
                               <strong>Tri·ªáu ch·ª©ng:</strong> kh√≥ k√™ n·ªôi th·∫•t, m·∫•t di·ªán t√≠ch s·ª≠ d·ª•ng.
                               <span class="legal-ref"><strong>CƒÉn c·ª© ph√°p l√Ω:</strong> ƒêi·ªÅu 1, Kho·∫£n 1b HƒêMB (quy ƒë·ªãnh v·ªÅ ch√™nh l·ªách di·ªán t√≠ch +/- 1%).</span>`
                    },
                    {
                        id: '1-2', text: 'T∆∞·ªùng, tr·∫ßn, s√†n', isIssue: true,
                        note: `<strong>Th√†nh ph·∫ßn:</strong> l·ªõp s∆°n, g·∫°ch l√°t, tr·∫ßn th·∫°ch cao.<br>
                               <strong>D·∫•u hi·ªáu:</strong> n·ª©t ch√¢n t∆∞·ªùng, ·ªë m·ªëc, ph·ªìng r·ªôp, s√†n b·ªã b·ªôp (r·ªóng).<br>
                               <strong>Tri·ªáu ch·ª©ng:</strong> th·∫•m n∆∞·ªõc, bong tr√≥c, xu·ªëng c·∫•p nhanh.
                               <span class="legal-ref"><strong>CƒÉn c·ª© ph√°p l√Ω:</strong> Ph·ª• l·ª•c 1 HƒêMB; ƒêi·ªÅu 8 HƒêMB (v·ªÅ b·∫£o h√†nh).</span>`
                    },
                    {
                        id: '1-3', text: 'C·ª≠a ƒëi, c·ª≠a s·ªï', isIssue: true,
                        note: `<strong>Th√†nh ph·∫ßn:</strong> b·∫£n l·ªÅ, kho√°, k√≠nh, ron.<br>
                               <strong>D·∫•u hi·ªáu:</strong> k·∫πt, ron h·ªü, k√≠nh x∆∞·ªõc, b·∫£n l·ªÅ x·ªá.<br>
                               <strong>Tri·ªáu ch·ª©ng:</strong> kh√¥ng an to√†n, th·∫•t tho√°t nhi·ªát, th·∫•m n∆∞·ªõc khi m∆∞a.
                               <span class="legal-ref"><strong>CƒÉn c·ª© ph√°p l√Ω:</strong> Ph·ª• l·ª•c 1 HƒêMB.</span>`
                    },
                    {
                        id: '1-4', text: 'Ban c√¥ng/logia', isIssue: true,
                        note: `<strong>Th√†nh ph·∫ßn:</strong> lan can, g·∫°ch n·ªÅn, tho√°t s√†n.<br>
                               <strong>D·∫•u hi·ªáu:</strong> lan can l·ªèng, tho√°t n∆∞·ªõc ch·∫≠m.<br>
                               <strong>Tri·ªáu ch·ª©ng:</strong> n∆∞·ªõc tr√†n ng∆∞·ª£c, nguy hi·ªÉm r∆°i ng√£.
                               <span class="legal-ref"><strong>CƒÉn c·ª© ph√°p l√Ω:</strong> ƒêi·ªÅu 8 HƒêMB (b·∫£o h√†nh k·∫øt c·∫•u).</span>`
                    },
                    {
                        id: '1-5', text: 'Nh√† v·ªá sinh', isIssue: true,
                        note: `<strong>Th√†nh ph·∫ßn:</strong> lavabo, v√≤i sen, b·ªìn c·∫ßu, qu·∫°t h√∫t.<br>
                               <strong>D·∫•u hi·ªáu:</strong> b·ªìn c·∫ßu r√≤ r·ªâ, tho√°t ch·∫≠m, qu·∫°t h·ªèng, thi·∫øt b·ªã sai ch·ªßng lo·∫°i.<br>
                               <strong>Tri·ªáu ch·ª©ng:</strong> h√¥i, th·∫•m sang cƒÉn kh√°c.
                               <span class="legal-ref"><strong>CƒÉn c·ª© ph√°p l√Ω:</strong> Ph·ª• l·ª•c 1 HƒêMB.</span>`
                    },
                     {
                        id: '1-6', text: 'B·∫£n v·∫Ω ho√†n c√¥ng', isIssue: true,
                        note: `<strong>Th√†nh ph·∫ßn:</strong> s∆° ƒë·ªì v·ªã tr√≠, k√≠ch th∆∞·ªõc, thi·∫øt b·ªã.<br>
                               <strong>D·∫•u hi·ªáu:</strong> sai k√≠ch th∆∞·ªõc, l·∫Øp sai v·ªã tr√≠ ·ªï c·∫Øm, ƒë·∫ßu ch·ªù so v·ªõi b·∫£n v·∫Ω.<br>
                               <strong>Tri·ªáu ch·ª©ng:</strong> v∆∞·ªõng ph√°p l√Ω, kh√≥ khƒÉn khi s·ª≠a ch·ªØa, l·∫Øp ƒë·∫∑t n·ªôi th·∫•t.
                               <span class="legal-ref"><strong>CƒÉn c·ª© ph√°p l√Ω:</strong> ƒêi·ªÅu 4, Kho·∫£n 2a HƒêMB.</span>`
                    }
                ]
            },
            {
                id: 'section2',
                title: 'üîå Ki·ªÉm Tra H·ªá Th·ªëng K·ªπ Thu·∫≠t',
                items: [
                     {
                        id: '2-1', text: 'H·ªá th·ªëng ƒëi·ªán', isIssue: true,
                        note: `<strong>Th√†nh ph·∫ßn:</strong> CB, ·ªï c·∫Øm, c√¥ng t·∫Øc, ƒë√®n.<br>
                               <strong>D·∫•u hi·ªáu:</strong> ·ªï c·∫Øm n√≥ng, c√¥ng t·∫Øc l·ªèng, ƒë√®n ch·ªõp, CB kh√¥ng c√≥ ghi ch√∫.<br>
                               <strong>Tri·ªáu ch·ª©ng:</strong> ch·∫≠p ƒëi·ªán, ch√°y n·ªï.
                               <span class="legal-ref"><strong>CƒÉn c·ª© ph√°p l√Ω:</strong> Ph·ª• l·ª•c 1 HƒêMB.</span>`
                    },
                    {
                        id: '2-2', text: 'H·ªá th·ªëng c·∫•p tho√°t n∆∞·ªõc', isIssue: true,
                        note: `<strong>Th√†nh ph·∫ßn:</strong> ƒë∆∞·ªùng ·ªëng c·∫•p, tho√°t, van, ƒë·ªìng h·ªì.<br>
                               <strong>D·∫•u hi·ªáu:</strong> r√≤ r·ªâ, n∆∞·ªõc y·∫øu, van k·∫πt, tho√°t n∆∞·ªõc ch·∫≠m.<br>
                               <strong>Tri·ªáu ch·ª©ng:</strong> ·∫©m m·ªëc, chi ph√≠ n∆∞·ªõc cao.
                               <span class="legal-ref"><strong>CƒÉn c·ª© ph√°p l√Ω:</strong> Ph·ª• l·ª•c 1 HƒêMB; ƒêi·ªÅu 8 HƒêMB.</span>`
                    },
                    {
                        id: '2-3', text: 'H·ªá th·ªëng PCCC trong cƒÉn h·ªô', isIssue: true,
                        note: `<strong>Th√†nh ph·∫ßn:</strong> ƒë·∫ßu b√°o kh√≥i, ƒë·∫ßu phun sprinkler.<br>
                               <strong>D·∫•u hi·ªáu:</strong> ƒë·∫ßu b√°o b·ª•i b·∫©n, b·ªã s∆°n ph·ªß, ƒë·∫ßu phun c√≥ d·∫•u hi·ªáu r·ªâ n∆∞·ªõc.<br>
                               <strong>Tri·ªáu ch·ª©ng:</strong> kh√¥ng ho·∫°t ƒë·ªông khi c√≥ s·ª± c·ªë, g√¢y nguy hi·ªÉm.
                               <span class="legal-ref"><strong>CƒÉn c·ª© ph√°p l√Ω:</strong> Ph·ª• l·ª•c 1 HƒêMB; Lu·∫≠t PCCC.</span>`
                    },
                    {
                        id: '2-4', text: 'C·ªïng ƒëi·ªán & ·ªëng ƒë·ªìng m√°y l·∫°nh', isIssue: true,
                        note: `<strong>C√°ch ki·ªÉm tra:</strong> ƒëo ƒëi·ªán √°p, ki·ªÉm tra ·ªëng ƒë·ªìng c√≥ b·ªã m√≥p, g√£y.<br>
                               <strong>D·∫•u hi·ªáu:</strong> kh√¥ng c√≥ ƒëi·ªán, ·ªëng b·ªã b·∫πp, g√£y.<br>
                               <strong>Tri·ªáu ch·ª©ng:</strong> kh√¥ng ch·∫°y, r√≤ gas, h·ªèng thi·∫øt b·ªã.
                               <span class="legal-ref"><strong>CƒÉn c·ª© ph√°p l√Ω:</strong> Ph·ª• l·ª•c 1 HƒêMB (ghi r√µ ch·ªâ ƒë·∫∑t ·ªëng ch·ªù, kh√¥ng c·∫•p d√¢y).</span>`
                    },
                    {
                        id: '2-5', text: 'ƒê·∫ßu ch·ªù m√°y gi·∫∑t, b·∫øp, internet', isIssue: true,
                        note: `<strong>C√°ch ki·ªÉm tra:</strong> x√°c nh·∫≠n ƒë√∫ng v·ªã tr√≠ v√† s·ªë l∆∞·ª£ng ƒë·∫ßu ch·ªù c·∫•p/tho√°t n∆∞·ªõc, ·ªï c·∫Øm c√¥ng su·∫•t l·ªõn, c·ªïng m·∫°ng/TV.<br>
                               <strong>D·∫•u hi·ªáu:</strong> thi·∫øu, sai v·ªã tr√≠ so v·ªõi thi·∫øt k·∫ø.<br>
                               <strong>Tri·ªáu ch·ª©ng:</strong> ph·∫£i ƒëi l·∫°i ƒë∆∞·ªùng d√¢y, t·ªën k√©m, m·∫•t th·∫©m m·ªπ.
                               <span class="legal-ref"><strong>CƒÉn c·ª© ph√°p l√Ω:</strong> Ph·ª• l·ª•c 1 HƒêMB.</span>`
                    }
                ]
            },
            {
                id: 'section3',
                title: 'üè¢ Ki·ªÉm Tra Kh√¥ng Gian Chung',
                items: [
                    { id: '3-1', text: 'H√†nh lang, thang m√°y, thang b·ªô', isIssue: true, note: '<strong>D·∫•u hi·ªáu:</strong> ƒë√®n ch√°y, t∆∞·ªùng b·∫©n, thang m√°y k√™u, c·ª≠a tho√°t hi·ªÉm b·ªã ch·∫∑n ho·∫∑c kh√¥ng t·ª± ƒë√≥ng. <br><strong>Tri·ªáu ch·ª©ng:</strong> b·∫•t ti·ªán, thi·∫øu an to√†n khi c√≥ s·ª± c·ªë.' },
                    { id: '3-2', text: 'Ph√≤ng sinh ho·∫°t c·ªông ƒë·ªìng, ph√≤ng r√°c', isIssue: true, note: '<strong>D·∫•u hi·ªáu:</strong> ph√≤ng r√°c h√¥i, kh√¥ng c√≥ h·ªá th·ªëng th√¥ng gi√≥, ph√≤ng c·ªông ƒë·ªìng b·ª´a b·ªôn, thi·∫øu trang thi·∫øt b·ªã. <br><strong>Tri·ªáu ch·ª©ng:</strong> ·∫£nh h∆∞·ªüng ch·∫•t l∆∞·ª£ng s·ªëng, v·ªá sinh m√¥i tr∆∞·ªùng.' },
                    { id: '3-3', text: 'H·ªá th·ªëng PCCC chung', isIssue: true, note: '<strong>D·∫•u hi·ªáu:</strong> h·ªôp c·ª©u h·ªèa kh√¥ng c√≥ v√≤i/lƒÉng, chu√¥ng b√°o ch√°y kh√¥ng ho·∫°t ƒë·ªông (khi th·ª≠ nghi·ªám), b√¨nh ch·ªØa ch√°y h·∫øt h·∫°n. <br><strong>Tri·ªáu ch·ª©ng:</strong> c·ª±c k·ª≥ nguy hi·ªÉm khi c√≥ ch√°y n·ªï.' }
                ]
            },
            {
                id: 'section4',
                title: '‚úçÔ∏è K√Ω K·∫øt & C√°c V·∫•n ƒê·ªÅ C·∫ßn Tr√°nh',
                items: [
                    { id: '4-1', text: 'B·∫•t l·ª£i c·∫ßn tr√°nh khi k√Ω', type: 'warning', isIssue: true, note: `<strong>Tuy·ªát ƒë·ªëi kh√¥ng:</strong>
                               <ul class="list-disc pl-5">
                                   <li>K√Ω khi thi·∫øu c√°c h·ªì s∆° ph√°p l√Ω quan tr·ªçng (m·ª•c 0-1).</li>
                                   <li>K√Ω v√†o cam k·∫øt "ƒë√£ ƒë·ªß ƒëi·ªÅu ki·ªán" ho·∫∑c "kh√¥ng khi·∫øu n·∫°i" khi th·ª±c t·∫ø c√≤n l·ªói.</li>
                                   <li>ƒê√≥ng c√°c kho·∫£n ph√≠ kh√¥ng c√≥ trong h·ª£p ƒë·ªìng m√† kh√¥ng c√≥ gi·∫£i tr√¨nh v√† vƒÉn b·∫£n h·ª£p l·ªá.</li>
                               </ul>
                               <span class="legal-ref"><strong>CƒÉn c·ª© ph√°p l√Ω:</strong> ƒêi·ªÅu 5 HƒêMB (Quy·ªÅn c·ªßa B√™n Mua).</span>` },
                    { id: '4-2', text: 'Y√™u c·∫ßu v·ªÅ kh·∫Øc ph·ª•c & b·∫£o h√†nh', type: 'warning', isIssue: false, note: `<strong>Ph·∫£i ghi r√µ trong bi√™n b·∫£n:</strong>
                               <ul class="list-disc pl-5">
                                   <li>Danh s√°ch t·∫•t c·∫£ c√°c l·ªói, h·∫°ng m·ª•c, t√¨nh tr·∫°ng.</li>
                                   <li><strong>Th·ªùi h·∫°n kh·∫Øc ph·ª•c c·ª• th·ªÉ (ng√†y/th√°ng/nƒÉm)</strong> cho t·ª´ng l·ªói.</li>
                                   <li>Th√¥ng tin ng∆∞·ªùi ph·ª• tr√°ch c·ªßa CƒêT v√† s·ªë ƒëi·ªán tho·∫°i li√™n h·ªá.</li>
                               </ul>
                               <span class="legal-ref"><strong>CƒÉn c·ª© ph√°p l√Ω:</strong> ƒêi·ªÅu 8, Kho·∫£n 4 HƒêMB (tr√°ch nhi·ªám b·∫£o h√†nh).</span>` },
                    { id: '4-3', text: 'Y√™u c·∫ßu v·ªÅ c√°c m·ªëc th·ªùi gian kh√°c', type: 'info', isIssue: false, note: 'Y√™u c·∫ßu CƒêT cung c·∫•p l·ªô tr√¨nh v√† ng√†y h·∫πn d·ª± ki·∫øn (th√°ng/nƒÉm) s·∫Ω ho√†n t·∫•t th·ªß t·ª•c v√† b√†n giao Gi·∫•y ch·ª©ng nh·∫≠n quy·ªÅn s·ªü h·ªØu. <span class="legal-ref"><strong>CƒÉn c·ª© ph√°p l√Ω:</strong> ƒêi·ªÅu 4, Kho·∫£n 2h HƒêMB.</span>' },
                    { 
                        id: '4-4', 
                        text: 'So·∫°n th·∫£o vƒÉn b·∫£n y√™u c·∫ßu ch√≠nh th·ª©c', 
                        note: 'N·∫øu CƒêT kh√¥ng h·ª£p t√°c ho·∫∑c c√≥ nhi·ªÅu v·∫•n ƒë·ªÅ nghi√™m tr·ªçng, h√£y s·ª≠ d·ª•ng t√≠nh nƒÉng "So·∫°n th·∫£o v·ªõi AI" ƒë·ªÉ t·∫°o m·ªôt vƒÉn b·∫£n khi·∫øu n·∫°i/y√™u c·∫ßu ch√≠nh th·ª©c g·ª≠i cho CƒêT.', 
                        geminiAction: 'draftEmail'
                    }
                ]
            }
        ];

        const container = document.getElementById('checklist-container');
        let state = {}; 
        let currentStream;
        let photoForItem = '';
        
        let mediaRecorder;
        let recordedChunks = [];
        let isRecording = false;
        let timerInterval;

        let currentGallery = [];
        let currentImageIndex = 0;

        function getNoteClass(type) {
            switch (type) {
                case 'warning': return 'bg-red-50 border-l-4 border-red-400 text-red-700';
                case 'info': return 'bg-blue-50 border-l-4 border-blue-400 text-blue-700';
                default: return 'bg-gray-50 border-l-4 border-gray-300 text-gray-700';
            }
        }
        
        function renderChecklist() {
            let totalItems = 0;
            let checkedItems = 0;
            container.innerHTML = '';

            const processItem = (item) => {
                if (item.isIssue !== false) { // Only count checkable items
                    totalItems++;
                    if (state[item.id] && state[item.id].checked) {
                        checkedItems++;
                    }
                }
            };
            checklistData.forEach(section => section.items.forEach(processItem));

            checklistData.forEach(section => {
                const sectionDiv = document.createElement('details');
                sectionDiv.className = 'bg-white rounded-xl shadow-md overflow-hidden';
                sectionDiv.open = true;

                const summary = document.createElement('summary');
                summary.className = 'p-4 sm:p-5 cursor-pointer flex justify-between items-center bg-gray-50 hover:bg-gray-100 transition-colors';
                summary.innerHTML = `<h2 class="text-lg sm:text-xl font-bold text-gray-800">${section.title}</h2><svg class="w-6 h-6 text-gray-500 arrow transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>`;
                sectionDiv.appendChild(summary);

                const contentDiv = document.createElement('div');
                contentDiv.className = 'p-4 sm:p-5 border-t border-gray-200 divide-y divide-gray-200';
                
                section.items.forEach(item => {
                    contentDiv.appendChild(createChecklistItem(item));
                });
                sectionDiv.appendChild(contentDiv);
                container.appendChild(sectionDiv);
            });
            updateProgress(checkedItems, totalItems);
        }

        function createChecklistItem(item) {
            const itemState = state[item.id] || { checked: false, media: [] };
            const isChecked = itemState.checked;
            
            const itemDiv = document.createElement('div');
            itemDiv.className = `checklist-item py-4 ${isChecked ? 'checked' : ''}`;
            
            let geminiButtonHtml = '';
            if (item.geminiAction === 'draftEmail') {
                geminiButtonHtml = `<button onclick="openDraftEmailModal()" title="So·∫°n th·∫£o v·ªõi AI" class="action-button ml-4 p-2 bg-gradient-to-r from-purple-400 to-blue-500 text-white rounded-full shadow-md text-xs">‚ú®</button>`;
            }

            let mediaSectionHtml = '<div class="mt-3 pl-8 thumbnail-container">';
            if (item.isIssue !== false) {
                if (itemState.media && itemState.media.length > 0) {
                    mediaSectionHtml += '<div class="flex flex-wrap gap-3 items-center">';
                    itemState.media.forEach(mediaFile => {
                        const playIcon = mediaFile.type === 'video' ? `<div class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-20"><svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"></path></svg></div>` : '';
                        mediaSectionHtml += `
                            <div class="relative group">
                                <img src="${mediaFile.thumbnail}" onclick="showMediaPreview('${item.id}', '${mediaFile.filename}')" class="h-20 w-20 rounded-lg object-cover cursor-pointer shadow-md hover:shadow-xl transition-shadow" alt="${mediaFile.filename}">
                                ${playIcon}
                                <button onclick="deleteMedia('${item.id}', '${mediaFile.filename}')" class="delete-btn absolute -top-2 -right-2 bg-red-500 text-white rounded-full h-5 w-5 flex items-center justify-center text-xs font-bold opacity-0 group-hover:opacity-100 transition-opacity">&times;</button>
                            </div>
                        `;
                    });
                     mediaSectionHtml += `
                        <div onclick="openCameraModal('${item.id}', '${item.text}')" title="Th√™m ghi nh·∫≠n" class="group h-20 w-20 rounded-lg border-2 border-dashed border-gray-300 flex items-center justify-center cursor-pointer hover:bg-gray-100 hover:border-gray-400 transition-colors">
                            <svg class="w-8 h-8 text-gray-400 group-hover:text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                        </div>
                    `;
                    mediaSectionHtml += '</div>';
                } else {
                     mediaSectionHtml += `
                        <button onclick="openCameraModal('${item.id}', '${item.text}')" class="inline-flex items-center gap-2 mt-2 px-3 py-1.5 bg-gray-100 text-gray-600 rounded-full text-xs font-medium cursor-pointer hover:bg-gray-200">
                             <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                            <span>Th√™m ·∫£nh/video ghi nh·∫≠n</span>
                        </button>
                     `;
                }
            }
            mediaSectionHtml += '</div>';
            
            const checkboxHtml = item.isIssue !== false 
                ? `<input type="checkbox" id="${item.id}" class="mt-1 h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500 cursor-pointer flex-shrink-0" ${isChecked ? 'checked' : ''}>`
                : `<div class="h-5 w-5 flex-shrink-0"></div>`;

            itemDiv.innerHTML = `
                <div class="flex items-start space-x-4">
                    ${checkboxHtml}
                    <div class="flex-1 flex justify-between items-center">
                        <label for="${item.id}" class="font-medium text-gray-900 ${item.isIssue !== false ? 'cursor-pointer' : ''}">${item.text}</label>
                        ${geminiButtonHtml}
                    </div>
                </div>
                <div class="pl-9">
                    ${item.note ? `<div class="note text-sm mt-2 p-3 rounded-md ${getNoteClass(item.type)}">${item.note}</div>` : ''}
                    ${mediaSectionHtml}
                </div>
            `;

            if (item.isIssue !== false) {
                itemDiv.querySelector('input').addEventListener('change', (e) => handleCheck(e.target.id, e.target.checked));
            }
            return itemDiv;
        }

        function handleCheck(id, isChecked) {
            if (!state[id]) {
                state[id] = { checked: false, media: [] };
            }
            state[id].checked = isChecked;
            localStorage.setItem('checklistState', JSON.stringify(state));
            renderChecklist();
        }
        
        function deleteMedia(itemId, filename) {
            if (state[itemId] && state[itemId].media) {
                const mediaFile = state[itemId].media.find(m => m.filename === filename);
                if (mediaFile && mediaFile.type === 'video') {
                    URL.revokeObjectURL(mediaFile.dataUrl);
                }
                state[itemId].media = state[itemId].media.filter(m => m.filename !== filename);
                localStorage.setItem('checklistState', JSON.stringify(state));
                renderChecklist();
            }
        }

        function updateProgress(checked, total) {
            const percentage = total > 0 ? Math.round((checked / total) * 100) : 0;
            document.getElementById('progress-bar').style.width = `${percentage}%`;
            document.getElementById('progress-text').textContent = `${percentage}%`;
        }
        
        function printChecklist() { window.print(); }
        
        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
            if (modalId === 'image-preview-modal') {
                window.removeEventListener('keydown', handleKeyPress);
                const video = document.getElementById('preview-video');
                video.pause();
                video.src = '';
            }
        }

        async function openCameraModal(itemId, itemText) {
            photoForItem = { id: itemId, text: itemText };
            const cameraModal = document.getElementById('camera-modal');
            const video = document.getElementById('camera-stream');
            cameraModal.classList.remove('hidden');

            try {
                if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                    currentStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: true });
                    video.srcObject = currentStream;
                    document.getElementById('record-btn').textContent = 'B·∫Øt ƒë·∫ßu Quay';
                    isRecording = false;
                } else {
                    alert('Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ truy c·∫≠p camera.');
                    closeCamera();
                }
            } catch (err) {
                console.error("Error accessing camera: ", err);
                alert('Kh√¥ng th·ªÉ truy c·∫≠p camera. Vui l√≤ng c·∫•p quy·ªÅn v√† th·ª≠ l·∫°i.');
                closeCamera();
            }
        }
        
        function closeCamera() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
            }
            if (isRecording) {
                mediaRecorder.stop();
            }
            clearInterval(timerInterval);
            document.getElementById('timer').classList.add('hidden');
            document.getElementById('camera-modal').classList.add('hidden');
        }

        function capturePhoto() {
            const canvas = document.getElementById('camera-canvas');
            const video = document.getElementById('camera-stream');
            const context = canvas.getContext('2d');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, video.videoWidth, video.videoHeight);
            
            const dataUrl = canvas.toDataURL('image/jpeg', 0.9);
            const filename = generateFilename('jpg');
            
            saveMedia({ type: 'image', filename, dataUrl, thumbnail: dataUrl });
            
            const link = document.createElement('a');
            link.href = dataUrl;
            link.download = filename;
            link.click();
            closeCamera();
        }

        function toggleRecording() {
            const recordBtn = document.getElementById('record-btn');
            const captureBtn = document.getElementById('capture-btn');
            const timerDiv = document.getElementById('timer');

            if (!currentStream || !currentStream.active) {
                alert("L·ªói: Kh√¥ng t√¨m th·∫•y t√≠n hi·ªáu camera. Vui l√≤ng th·ª≠ m·ªü l·∫°i c·ª≠a s·ªï ghi nh·∫≠n.");
                return;
            }

            if (isRecording) {
                mediaRecorder.stop();
                recordBtn.textContent = 'B·∫Øt ƒë·∫ßu Quay';
                captureBtn.disabled = false;
                isRecording = false;
                clearInterval(timerInterval);
                timerDiv.classList.add('hidden');
            } else {
                recordedChunks = [];
                try {
                    mediaRecorder = new MediaRecorder(currentStream, { mimeType: 'video/webm' });
                } catch (e) {
                    console.error("Error creating MediaRecorder:", e);
                    alert("Kh√¥ng th·ªÉ t·∫°o tr√¨nh ghi video. Tr√¨nh duy·ªát c·ªßa b·∫°n c√≥ th·ªÉ kh√¥ng h·ªó tr·ª£ ƒë·ªãnh d·∫°ng n√†y.");
                    return;
                }

                mediaRecorder.ondataavailable = event => {
                    if (event.data.size > 0) {
                        recordedChunks.push(event.data);
                    }
                };
                mediaRecorder.onstop = () => {
                    const blob = new Blob(recordedChunks, { type: 'video/webm' });
                    const videoUrl = URL.createObjectURL(blob);
                    
                    const video = document.createElement('video');
                    video.src = videoUrl;
                    video.onloadeddata = () => {
                        const canvas = document.getElementById('camera-canvas');
                        canvas.width = video.videoWidth;
                        canvas.height = video.videoHeight;
                        canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
                        const thumbnailUrl = canvas.toDataURL('image/jpeg');
                        
                        const filename = generateFilename('webm');
                        saveMedia({ type: 'video', filename, dataUrl: videoUrl, thumbnail: thumbnailUrl });
                        
                        const link = document.createElement('a');
                        link.href = videoUrl;
                        link.download = filename;
                        link.click();
                        closeCamera();
                    };
                };

                mediaRecorder.start();
                recordBtn.textContent = 'D·ª´ng Quay';
                captureBtn.disabled = true;
                isRecording = true;
                
                let seconds = 0;
                timerDiv.classList.remove('hidden');
                timerDiv.textContent = '00:00';
                timerInterval = setInterval(() => {
                    seconds++;
                    const min = Math.floor(seconds / 60).toString().padStart(2, '0');
                    const sec = (seconds % 60).toString().padStart(2, '0');
                    timerDiv.textContent = `${min}:${sec}`;
                }, 1000);
            }
        }
        
        function generateFilename(extension) {
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            const sanitizedText = photoForItem.text.replace(/[/\\?%*:|"<>\r\n]/g, '-').substring(0, 50);
            return `GoldenCity - ${sanitizedText} - ${timestamp}.${extension}`;
        }
        
        function saveMedia(mediaObject) {
             if (!state[photoForItem.id]) {
                state[photoForItem.id] = { checked: false, media: [] };
            }
            state[photoForItem.id].media.push(mediaObject);
            localStorage.setItem('checklistState', JSON.stringify(state));
            renderChecklist();
        }

        function showMediaPreview(itemId, filename) {
            const itemState = state[itemId];
            if (!itemState || !itemState.media || itemState.media.length === 0) return;
            currentGallery = itemState.media;
            currentImageIndex = currentGallery.findIndex(m => m.filename === filename);
            if (currentImageIndex === -1) return;
            
            document.getElementById('image-preview-modal').classList.remove('hidden');
            window.addEventListener('keydown', handleKeyPress);
            updatePreviewContent();
        }

        function updatePreviewContent() {
            if (currentGallery.length === 0) {
                closeModal('image-preview-modal');
                return;
            }
            if (currentImageIndex < 0) currentImageIndex = 0;
            if (currentImageIndex >= currentGallery.length) currentImageIndex = currentGallery.length - 1;

            const mediaFile = currentGallery[currentImageIndex];
            const previewImage = document.getElementById('preview-image');
            const previewVideo = document.getElementById('preview-video');
            const galleryThumbs = document.getElementById('gallery-thumbnails');

            galleryThumbs.innerHTML = '';
            currentGallery.forEach((file, index) => {
                const playIcon = file.type === 'video' ? `<div class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-30"><svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20"><path d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z"></path></svg></div>` : '';
                const thumbDiv = document.createElement('div');
                thumbDiv.className = `gallery-thumbnail relative h-16 w-16 rounded-md cursor-pointer border-2 ${index === currentImageIndex ? 'border-blue-500' : 'border-transparent'}`;
                thumbDiv.innerHTML = `<img src="${file.thumbnail}" class="h-full w-full object-cover rounded-md">${playIcon}`;
                thumbDiv.onclick = () => {
                    currentImageIndex = index;
                    updatePreviewContent();
                };
                galleryThumbs.appendChild(thumbDiv);
            });


            if (mediaFile.type === 'image') {
                previewImage.src = mediaFile.dataUrl;
                previewImage.classList.remove('hidden');
                previewVideo.classList.add('hidden');
                previewVideo.pause();
                previewVideo.src = '';
            } else { 
                previewVideo.src = mediaFile.dataUrl;
                previewVideo.classList.remove('hidden');
                previewImage.classList.add('hidden');
                previewImage.src = '';
            }

            const prevBtn = document.getElementById('prev-image-btn');
            const nextBtn = document.getElementById('next-image-btn');

            if (currentGallery.length > 1) {
                prevBtn.classList.remove('hidden');
                nextBtn.classList.remove('hidden');
                prevBtn.disabled = currentImageIndex === 0;
                nextBtn.disabled = currentImageIndex === currentGallery.length - 1;
            } else {
                prevBtn.classList.add('hidden');
                nextBtn.classList.add('hidden');
            }
        }
        
        function navigateGallery(direction) {
            const newIndex = currentImageIndex + direction;
            if (newIndex >= 0 && newIndex < currentGallery.length) {
                currentImageIndex = newIndex;
                updatePreviewContent();
            }
        }
        
        function handleKeyPress(event) {
            if (event.key === 'ArrowLeft') {
                navigateGallery(-1);
            } else if (event.key === 'ArrowRight') {
                navigateGallery(1);
            } else if (event.key === 'Escape') {
                closeModal('image-preview-modal');
            }
        }

        function openDraftEmailModal() {
            const issuesListDiv = document.getElementById('issues-list');
            issuesListDiv.innerHTML = '';
            const detectedIssues = [];

            const findIssues = (item) => {
                if (state[item.id] && state[item.id].checked && item.isIssue) {
                    detectedIssues.push({id: item.id, text: item.text});
                }
            };
            checklistData.forEach(section => section.items.forEach(findIssues));
            
            detectedIssues.forEach(issue => {
                issuesListDiv.innerHTML += `<label class="flex items-center space-x-3"><input type="checkbox" name="issue" value="${issue.text}" class="form-checkbox h-5 w-5 text-blue-600" checked><span class="text-gray-700">${issue.text}</span></label>`;
            });
            
            document.getElementById('gemini-modal').classList.remove('hidden');
            document.getElementById('gemini-result-container').classList.add('hidden');
            document.getElementById('gemini-loader').classList.add('hidden');
        }

        async function generateEmail() {
            const selectedIssuesNodes = document.querySelectorAll('input[name="issue"]:checked');
            const selectedIssues = Array.from(selectedIssuesNodes).map(node => node.value);
            const customIssue = document.getElementById('custom-issue').value;
            if (selectedIssues.length === 0 && !customIssue) {
                alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt v·∫•n ƒë·ªÅ ho·∫∑c nh·∫≠p y√™u c·∫ßu c·ªßa b·∫°n.');
                return;
            }
            const loader = document.getElementById('gemini-loader');
            const resultContainer = document.getElementById('gemini-result-container');
            const resultDiv = document.getElementById('gemini-result');
            loader.classList.remove('hidden');
            resultContainer.classList.add('hidden');
            let prompt = `B·∫°n l√† m·ªôt tr·ª£ l√Ω ph√°p l√Ω cho ng∆∞·ªùi mua nh√† ·ªü x√£ h·ªôi t·∫°i Vi·ªát Nam. H√£y so·∫°n m·ªôt vƒÉn b·∫£n (d·∫°ng ƒë∆°n khi·∫øu n·∫°i ho·∫∑c email) trang tr·ªçng, l·ªãch s·ª± nh∆∞ng ki√™n quy·∫øt ƒë·ªÉ g·ª≠i cho Ch·ªß ƒë·∫ßu t∆∞ d·ª± √°n Nh√† ·ªü x√£ h·ªôi Golden City An Giang. N·ªôi dung c·∫ßn ƒë·ªÅ c·∫≠p c√°c v·∫•n ƒë·ªÅ sau:\n\n`;
            selectedIssues.forEach(issue => { prompt += `- ${issue}\n`; });
            if(customIssue) { prompt += `- V·∫•n ƒë·ªÅ b·ªï sung: ${customIssue}\n`; }
            prompt += `\nVƒÉn b·∫£n c·∫ßn y√™u c·∫ßu Ch·ªß ƒë·∫ßu t∆∞ ph·∫£n h·ªìi v·ªÅ l·ªô tr√¨nh kh·∫Øc ph·ª•c c√°c v·∫•n ƒë·ªÅ tr√™n v√† th·ª±c hi·ªán nghƒ©a v·ª• b·ªìi th∆∞·ªùng ch·∫≠m b√†n giao theo h·ª£p ƒë·ªìng. Cu·ªëi th∆∞, h√£y ghi r√µ th√¥ng tin ng∆∞·ªùi g·ª≠i l√† "ƒê·∫°i di·ªán c√°c h·ªô d√¢n mua nh√† t·∫°i t√≤a T3, T4" v√† ƒë·ªÉ tr·ªëng ph·∫ßn k√Ω t√™n.`;
            
            try {
                let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                const payload = { contents: chatHistory };
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) { throw new Error(`API call failed with status: ${response.status}`); }
                const result = await response.json();
                if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts) {
                    const text = result.candidates[0].content.parts[0].text;
                    resultDiv.innerHTML = text.replace(/\n/g, '<br>');
                } else {
                   resultDiv.innerText = 'R·∫•t ti·∫øc, ƒë√£ c√≥ l·ªói x·∫£y ra. Kh√¥ng nh·∫≠n ƒë∆∞·ª£c ph·∫£n h·ªìi h·ª£p l·ªá t·ª´ AI. Vui l√≤ng th·ª≠ l·∫°i.';
                }
            } catch (error) {
                 resultDiv.innerText = `ƒê√£ x·∫£y ra l·ªói khi k·∫øt n·ªëi ƒë·∫øn Gemini AI. Vui l√≤ng ki·ªÉm tra l·∫°i. L·ªói: ${error.message}`;
            } finally {
                loader.classList.add('hidden');
                resultContainer.classList.remove('hidden');
            }
        }
        
        function copyToClipboard() {
            const textToCopy = document.getElementById('gemini-result').innerText;
            const tempTextArea = document.createElement('textarea');
            tempTextArea.value = textToCopy;
            document.body.appendChild(tempTextArea);
            tempTextArea.select();
            document.execCommand('copy');
            document.body.removeChild(tempTextArea);
            alert('ƒê√£ sao ch√©p n·ªôi dung v√†o b·ªô nh·ªõ t·∫°m!');
        }

        const savedState = localStorage.getItem('checklistState');
        if (savedState) { state = JSON.parse(savedState); }
        renderChecklist();
    </script>

</body>
</html>
