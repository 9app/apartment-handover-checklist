<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checklist Hoàn Chỉnh Bàn Giao Căn Hộ (cho phép tùy chỉnh) - Golden City An Giang</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.0/FileSaver.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        details > summary {
            list-style: none;
        }
        details > summary::-webkit-details-marker {
            display: none;
        }
        details[open] summary .arrow {
            transform: rotate(90deg);
        }
        .checklist-item {
            transition: all 0.2s ease-in-out;
        }
        .checklist-item.checked .note, .checklist-item.checked .media-list-title {
            text-decoration: none;
            color: #6b7280;
        }
        .sticky-progress {
            position: -webkit-sticky;
            position: sticky;
            top: 0;
            z-index: 50;
            transition: all 0.3s ease;
        }
        .sticky-progress.collapsed {
            padding-top: 1rem;
            padding-bottom: 1rem;
        }
        .action-button {
            transition: all 0.2s ease-in-out;
        }
        .action-button:hover {
            transform: scale(1.1);
        }
        .thumbnail-container .group:hover .delete-btn {
            opacity: 1;
        }
        .nav-button:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        .gallery-thumbnail.active {
            border-color: #3b82f6; /* Tailwind's blue-500 */
        }
        .note ul {
            margin-top: 0.5rem;
        }
        .note strong {
            color: #1f2937;
        }
        .legal-ref {
            display: block;
            margin-top: 8px;
            font-style: italic;
            color: #4b5563;
        }
        /* Styles for manual toggle progress panel */        
        #collapsible-content {
            transition: all 0.3s ease;
            opacity: 1;
            max-height: 1000px; /* Large enough to accommodate content */
            overflow: hidden;
        }
        
        .sticky-progress.collapsed #collapsible-content {
            opacity: 0;
            max-height: 0;
            padding-top: 0;
            margin-top: 0;
        }
        
        #toggle-icon {
            transition: transform 0.3s ease;
        }
        
        .sticky-progress.collapsed #toggle-icon {
            transform: rotate(-90deg);
        }
        
        /* Hover effect for toggle button */
        .progress-header button:hover {
            background-color: #f3f4f6;
        }
        
        /* Ensure proper text rendering */
        .checklist-item label {
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        
        /* Responsive improvements for manual toggle */
        @media (max-width: 768px) {
            .checklist-item {
                padding-left: 0.5rem;
                padding-right: 0.5rem;
            }
            
            .progress-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }
            
            .progress-header > div:last-child {
                align-self: flex-end;
                display: flex;
                align-items: center;
                gap: 0.75rem;
            }
            
            .status-indicators {
                font-size: 0.75rem;
            }
            
            .camera-button {
                padding: 0.5rem;
            }
            
            .media-thumbnail {
                height: 3rem;
                width: 3rem;
            }
            
            .note-textarea {
                font-size: 0.875rem;
            }
            
            .checklist-item .note {
                margin-left: 0;
                padding-left: 1rem;
            }
            
            .thumbnail-container {
                padding-left: 1rem;
            }
            
            .action-buttons {
                flex-direction: column;
                align-items: stretch;
                gap: 0.5rem;
            }
            
            .action-buttons button {
                width: 100%;
                justify-content: center;
            }
        }
        
        @media (max-width: 480px) {
            .container {
                padding-left: 0.75rem;
                padding-right: 0.75rem;
            }
            
            .media-thumbnail {
                height: 2.5rem;
                width: 2.5rem;
            }
            
            .checklist-item {
                font-size: 0.875rem;
            }
        }

        /* Custom styles */
        .checklist-item.checked label {
            text-decoration: line-through;
            color: #6b7280; /* gray-500 */
        }
        .checklist-item.checked .status-indicators span {
            text-decoration: none !important;
        }
        .arrow {
            transition: transform 0.2s ease-in-out;
        }
        details[open] .arrow {
            transform: rotate(90deg);
        }
        .delete-btn {
            transition: opacity 0.2s, transform 0.2s;
        }
        .thumbnail-container:hover .delete-btn {
            opacity: 1;
            transform: scale(1);
        }
        @media print {
            body {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            .no-print {
                display: none;
            }
            /* Hide empty add forms when printing */
            .add-sign-form, .add-symptom-form {
                display: none !important;
            }
            /* Hide note buttons when printing */
            .note-add-button {
                display: none !important;
            }
            /* Hide action buttons when printing */
            .action-buttons {
                display: none !important;
            }
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="container mx-auto max-w-4xl p-3 sm:p-4 md:p-6 lg:p-8">
        <header class="text-center mb-8">
            <h1 class="text-2xl sm:text-3xl font-bold text-gray-800">
                CHECKLIST<br/>BÀN GIAO CĂN HỘ<br/>
                <span id="apartment-code-display" onclick="editApartmentCode()" class="cursor-pointer hover:bg-yellow-100 rounded px-2 py-1 transition-colors inline-block" title="Nhấp để chỉnh sửa mã căn hộ">T3.0206A</span>
                <input type="text" id="apartment-code-input" class="hidden text-center bg-yellow-50 border-2 border-blue-400 rounded px-2 py-1 text-2xl sm:text-3xl font-bold text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500" onblur="saveApartmentCode()" onkeydown="handleApartmentCodeKeydown(event)" maxlength="20" placeholder="Nhập mã căn hộ">
            </h1>
            <p class="text-lg text-gray-600 mt-2">Dự án Nhà ở xã hội Golden City An Giang</p>
        </header>

        <div class="bg-white rounded-xl shadow-lg p-6 mb-6 sticky-progress">
            <!-- Header: always visible -->
            <div class="flex justify-between items-center progress-header">
                 <h2 class="text-lg font-semibold text-gray-700">Tiến độ kiểm tra</h2>
                 <div class="flex items-center gap-3">
                     <div class="text-right">
                         <span id="progress-text" class="font-bold text-blue-600">0%</span>
                         <div class="text-sm text-gray-500">
                             <span id="report-count" class="text-red-600 font-medium">0 vấn đề</span> cần báo cáo
                         </div>
                     </div>
                     <!-- Toggle button -->
                     <button onclick="toggleProgressPanel()" class="ml-2 p-1 rounded-lg hover:bg-gray-100 transition-colors" title="Thu gọn/Mở rộng">
                         <svg id="toggle-icon" class="w-5 h-5 text-gray-600 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                         </svg>
                     </button>
                 </div>
            </div>
            
            <!-- Collapsible content: hidden when collapsed -->
            <div id="collapsible-content">
                <div class="w-full bg-gray-200 rounded-full h-2.5 mt-4">
                    <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
                </div>
                <div class="mt-2 text-sm text-gray-600">
                    <span id="checked-count">0</span> / <span id="total-count">0</span> mục đã kiểm tra
                </div>
                <div class="flex flex-col sm:flex-row sm:flex-wrap justify-end items-stretch sm:items-center mt-4 gap-2 action-buttons">
                     <span id="zip-status" class="text-sm text-gray-600 mr-2 hidden"></span>
                     <button onclick="printChecklist()" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2.5 px-4 rounded-lg inline-flex items-center justify-center text-sm transition-all duration-200 hover:shadow-lg">
                        <svg class="w-4 h-4 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path></svg>
                        <span class="whitespace-nowrap">In</span>
                    </button>
                    <button id="zip-btn" onclick="confirmDownloadZip()" class="bg-orange-500 hover:bg-orange-600 text-white font-semibold py-2.5 px-4 rounded-lg inline-flex items-center justify-center text-sm transition-all duration-200 hover:shadow-lg">
                        <svg class="w-4 h-4 mr-2 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd" />
                        </svg>
                        <span class="whitespace-nowrap">Tải hình ảnh</span>
                    </button>
                     <button onclick="openDraftEmailModal()" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2.5 px-4 rounded-lg inline-flex items-center justify-center text-sm transition-all duration-200 hover:shadow-lg">
                        <svg class="w-4 h-4 mr-2 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M2.003 5.884L10 2l7.997 3.884A2 2 0 0019 7.616V16a2 2 0 01-2 2H3a2 2 0 01-2-2V7.616a2 2 0 001.003-1.732zM10 4.268L3.003 7.616l6.997 3.498 6.997-3.498L10 4.268zM3 9.416l6.997 3.498V16H3V9.416zm13.003 0L10 12.914V16h6.997V9.416z"></path></svg>
                        <span class="whitespace-nowrap">Email</span>
                    </button>
                </div>
            </div>
        </div>

        <div id="checklist-container" class="space-y-4">
            <!-- Checklist content will be generated by JavaScript -->
        </div>
    </div>
    
    <!-- Gemini Modal -->
    <div id="gemini-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden">
      <div class="relative top-20 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl leading-6 font-bold text-gray-900">✨ Soạn thảo Văn bản với Gemini AI</h3>
                <button onclick="closeModal('gemini-modal')" class="text-gray-400 hover:text-gray-600 text-3xl font-bold">&times;</button>
            </div>
          <div class="mt-2 px-7 py-3 text-left">
            <p class="text-sm text-gray-600 mb-4">Gemini sẽ giúp bạn soạn thảo một văn bản/email trang trọng dựa trên các vấn đề bạn đã phát hiện. Vui lòng chọn các nội dung cần đưa vào văn bản:</p>
            <div id="issues-list" class="space-y-2 mb-4 max-h-48 overflow-y-auto"></div>
            <textarea id="custom-issue" class="w-full h-20 p-2 border rounded-md" placeholder="Thêm các vấn đề khác hoặc yêu cầu cụ thể của bạn ở đây..."></textarea>
            <div id="gemini-result-container" class="mt-4 hidden">
                 <h4 class="font-semibold text-gray-800 mb-2">Văn bản do Gemini đề xuất:</h4>
                 <div class="w-full p-3 h-64 overflow-y-auto bg-gray-50 rounded-md border text-sm text-gray-800" id="gemini-result"></div>
                 <button onclick="copyToClipboard()" class="mt-2 bg-blue-100 text-blue-700 font-semibold py-1 px-3 rounded-lg text-xs">Sao chép nội dung</button>
            </div>
             <div id="gemini-loader" class="mt-4 hidden text-center"><p>Gemini đang suy nghĩ... ✨</p></div>
          </div>
          <div class="items-center px-4 py-3">
            <button id="generate-btn" onclick="generateEmail()" class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-300">Tạo Văn bản</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Camera Modal -->
    <div id="camera-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full z-50 hidden">
      <div class="relative top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 p-5 border w-full max-w-lg shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl leading-6 font-bold text-gray-900">📸 Ghi nhận bằng chứng</h3>
            <button onclick="closeCamera()" class="text-gray-400 hover:text-gray-600 text-3xl font-bold">&times;</button>
          </div>
          <div class="mt-2 relative">
            <video id="camera-stream" class="w-full h-auto bg-black rounded-md" autoplay playsinline></video>
            <canvas id="camera-canvas" class="hidden"></canvas>
            <div id="timer" class="absolute top-2 right-2 bg-red-600 text-white text-xs font-mono px-2 py-1 rounded-full hidden">00:00</div>
            <div id="camera-loading" class="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center rounded-md">
              <div class="text-white text-center">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-white mx-auto mb-2"></div>
                <p class="text-sm">Đang khởi động camera...</p>
              </div>
            </div>
          </div>
          <div class="flex items-center justify-center space-x-4 px-4 py-3">
            <button id="capture-btn" onclick="capturePhoto()" disabled class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md shadow-sm hover:bg-blue-600 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors">
              <span class="flex items-center">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
                Chụp ảnh
              </span>
            </button>
            <button id="record-btn" onclick="toggleRecording()" disabled class="px-4 py-2 bg-red-500 text-white text-base font-medium rounded-md shadow-sm hover:bg-red-600 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors">
              <span class="flex items-center">
                <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"></path>
                </svg>
                <span id="record-btn-text">Bắt đầu Quay</span>
              </span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Image Preview Modal -->
    <div id="image-preview-modal" class="fixed inset-0 bg-black bg-opacity-80 flex flex-col items-center justify-center z-[60] p-4 hidden">
        <div class="relative w-full max-w-4xl max-h-[80vh] flex items-center justify-center">
             <button id="prev-image-btn" onclick="navigateGallery(-1)" class="nav-button hidden absolute left-0 sm:-left-12 top-1/2 -translate-y-1/2 bg-white bg-opacity-20 hover:bg-opacity-40 text-white p-3 rounded-full transition-opacity">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
            </button>
            <div class="relative max-w-full max-h-full bg-white p-1 rounded-lg shadow-lg">
                <button onclick="closeModal('image-preview-modal')" class="absolute -top-3 -right-3 bg-white rounded-full h-8 w-8 flex items-center justify-center text-gray-700 hover:text-black z-20 text-2xl font-bold">&times;</button>
                <img id="preview-image" src="" alt="Image Preview" class="w-full h-full object-contain rounded-md hidden">
                <video id="preview-video" src="" alt="Video Preview" class="w-full h-full object-contain rounded-md hidden" controls autoplay></video>
            </div>
            <button id="next-image-btn" onclick="navigateGallery(1)" class="nav-button hidden absolute right-0 sm:-right-12 top-1/2 -translate-y-1/2 bg-white bg-opacity-20 hover:bg-opacity-40 text-white p-3 rounded-full transition-opacity">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
            </button>
        </div>
        <div id="gallery-thumbnails" class="mt-4 h-[80px] w-full max-w-4xl flex justify-center items-center gap-2 overflow-x-auto">
             <!-- Thumbnails will be populated here -->
        </div>
    </div>


    <script>
        const checklistData = [
            {
                id: '0_phap-ly-ho-so',
                title: '0️⃣ Kiểm Tra Pháp Lý & Hồ Sơ (QUAN TRỌNG NHẤT)',
                items: [
                    { 
                        id: '0-1', 
                        title: 'Điều kiện Bàn giao của Dự án',
                        note: `<strong>Yêu cầu CĐT cung cấp (bản gốc để đối chiếu và bản photo):</strong>
                               <ul class="list-disc pl-5">
                                   <li><strong>Văn bản chấp thuận kết quả nghiệm thu</strong> của Sở Xây dựng để đưa công trình vào sử dụng.</li>
                                   <li><strong>Biên bản nghiệm thu hoàn thành hạng mục PCCC</strong> của Cảnh sát PCCC.</li>
                               </ul>
                               <strong>Bất lợi cần tránh:</strong> Tuyệt đối không nhận nhà nếu thiếu các văn bản trên. Việc nhận bàn giao khi chưa đủ điều kiện pháp lý sẽ đẩy rủi ro về phía bạn.
                               <span class="legal-ref"><strong>Căn cứ pháp lý:</strong> Điều 125 Luật Xây dựng 2014; Điều 13 Luật Kinh doanh BĐS 2014; Điều 7 HĐMB.</span>`,
                        signs: [{ id: '0-1-sign-1', text: 'CĐT không cung cấp đủ giấy tờ', isIssue: true }],
                        symptoms: [{ id: '0-1-symptom-1', text: 'Rủi ro pháp lý, không làm được sổ hồng', isIssue: true }]
                    },
                    { 
                        id: '0-2', 
                        title: 'Đối chiếu Hợp đồng và các Phụ lục',
                        note: `<strong>Cần chuẩn bị:</strong> Bản gốc Hợp đồng mua bán (HĐMB) và tất cả các phụ lục đã ký.<br>
                               <strong>Lưu ý đặc biệt:</strong> Phụ lục 1 (Danh mục vật liệu) và Phụ lục 2 (Tiến độ thanh toán) là cơ sở để kiểm tra và đối chiếu.
                               <span class="legal-ref"><strong>Căn cứ pháp lý:</strong> Điều 1, Khoản 1e HĐMB.</span>`,
                        signs: [{ id: '0-2-sign-1', text: 'Thông tin trong các văn bản không khớp', isIssue: true }],
                        symptoms: [{ id: '0-2-symptom-1', text: 'Tranh chấp về sau', isIssue: true }]
                    },
                    { 
                        id: '0-3', 
                        title: 'Nội dung Biên bản Bàn giao',
                        note: `<strong>Trước khi ký, phải đảm bảo:</strong>
                               <ul class="list-disc pl-5">
                                   <li>Biên bản phải ghi đúng thông tin căn hộ, thông tin của bạn.</li>
                                   <li>Mọi sai sót, lỗi kỹ thuật phải được liệt kê chi tiết.</li>
                                   <li>Phải có cam kết về <strong>ngày tháng cụ thể</strong> khắc phục cho từng lỗi.</li>
                               </ul>
                               <strong>Bất lợi cần tránh:</strong> Không ký vào biên bản trống hoặc biên bản ghi nội dung chung chung như "bàn giao đúng hiện trạng". Mọi cam kết miệng đều không có giá trị.
                               <span class="legal-ref"><strong>Căn cứ pháp lý:</strong> Điều 7, Khoản 4 HĐMB.</span>`,
                        signs: [{ id: '0-3-sign-1', text: 'Biên bản ghi chung chung, không chi tiết lỗi', isIssue: true }],
                        symptoms: [{ id: '0-3-symptom-1', text: 'Mất quyền yêu cầu sửa chữa', isIssue: true }]
                    }
                ]
            },
            {
                id: '1_kiem-tra-thuc-te-can-ho',
                title: '1️⃣ Kiểm Tra Thực Tế Căn Hộ',
                items: [
                    {
                        id: '1-1', title: 'Diện tích thông thủy',
                        note: `<strong>Thiết bị kiểm tra:</strong> thước laser, thước dây.<br><span class="legal-ref"><strong>Căn cứ pháp lý:</strong> Điều 1, Khoản 1b HĐMB (quy định về chênh lệch diện tích +/- 1%).</span>`,
                        signs: [
                            { id: '1-1-sign-1', text: 'Sai diện tích so với hợp đồng', isIssue: true },
                            { id: '1-1-sign-2', text: 'Mép tường không vuông', isIssue: true },
                            { id: '1-1-sign-3', text: 'Chiều dài/rộng ngắn hơn bản vẽ', isIssue: true }
                        ],
                        symptoms: [
                            { id: '1-1-symptom-1', text: 'Khó kê nội thất', isIssue: true },
                            { id: '1-1-symptom-2', text: 'Mất diện tích sử dụng', isIssue: true }
                        ]
                    },
                    {
                        id: '1-2', title: 'Tường, trần, sàn',
                        note: `<strong>Thành phần:</strong> lớp sơn, gạch lát, trần thạch cao.<br><span class="legal-ref"><strong>Căn cứ pháp lý:</strong> Phụ lục 1 HĐMB; Điều 8 HĐMB (về bảo hành).</span>`,
                        signs: [
                            { id: '1-2-sign-1', text: 'Nứt chân tường, nứt tường', isIssue: true },
                            { id: '1-2-sign-2', text: 'Ố mốc, thấm nước', isIssue: true },
                            { id: '1-2-sign-3', text: 'Sơn phồng rộp, không đều màu', isIssue: true },
                            { id: '1-2-sign-4', text: 'Sàn gạch bị bộp (rỗng), sứt mẻ', isIssue: true }
                        ],
                        symptoms: [
                            { id: '1-2-symptom-1', text: 'Thấm nước, ẩm mốc', isIssue: true },
                            { id: '1-2-symptom-2', text: 'Bong tróc sơn, gạch', isIssue: true },
                            { id: '1-2-symptom-3', text: 'Xuống cấp nhanh, mất thẩm mỹ', isIssue: true }
                        ]
                    },
                    {
                        id: '1-3', title: 'Cửa đi, cửa sổ',
                        note: `<strong>Thành phần:</strong> bản lề, khoá, kính, ron.<br><span class="legal-ref"><strong>Căn cứ pháp lý:</strong> Phụ lục 1 HĐMB.</span>`,
                        signs: [
                            { id: '1-3-sign-1', text: 'Cửa bị kẹt, khó đóng mở', isIssue: true },
                            { id: '1-3-sign-2', text: 'Ron cao su bị hở, rách', isIssue: true },
                            { id: '1-3-sign-3', text: 'Kính bị xước, nứt', isIssue: true },
                            { id: '1-3-sign-4', text: 'Bản lề, khóa bị xệ, lỏng lẻo', isIssue: true }
                        ],
                        symptoms: [
                            { id: '1-3-symptom-1', text: 'Không an toàn, chống trộm kém', isIssue: true },
                            { id: '1-3-symptom-2', text: 'Thất thoát nhiệt (máy lạnh)', isIssue: true },
                            { id: '1-3-symptom-3', text: 'Thấm nước, ồn', isIssue: true }
                        ]
                    }
                ]
            },
            {
                id: '2_kiem-tra-he-thong-ky-thuat',
                title: '🔌 Kiểm Tra Hệ Thống Kỹ Thuật',
                items: [
                     {
                        id: '2-1', title: 'Hệ thống điện',
                        note: `<strong>Thành phần:</strong> CB, ổ cắm, công tắc, đèn.<br><span class="legal-ref"><strong>Căn cứ pháp lý:</strong> Phụ lục 1 HĐMB.</span>`,
                        signs: [
                            { id: '2-1-sign-1', text: 'Ổ cắm, công tắc bị lỏng', isIssue: true },
                            { id: '2-1-sign-2', text: 'Đèn chớp nháy, không sáng', isIssue: true },
                            { id: '2-1-sign-3', text: 'CB nhảy bất thường', isIssue: true }
                        ],
                        symptoms: [
                            { id: '2-1-symptom-1', text: 'Nguy cơ chập điện', isIssue: true },
                            { id: '2-1-symptom-2', text: 'Nguy cơ cháy nổ', isIssue: true }
                        ]
                    },
                    {
                        id: '2-2', title: 'Hệ thống cấp thoát nước',
                        note: `<strong>Thành phần:</strong> đường ống cấp, thoát, van, đồng hồ.<br><span class="legal-ref"><strong>Căn cứ pháp lý:</strong> Phụ lục 1 HĐMB; Điều 8 HĐMB.</span>`,
                        signs: [
                            { id: '2-2-sign-1', text: 'Rò rỉ nước tại các đầu nối, vòi', isIssue: true },
                            { id: '2-2-sign-2', text: 'Áp lực nước yếu', isIssue: true },
                            { id: '2-2-sign-3', text: 'Van khóa bị kẹt, không hoạt động', isIssue: true },
                            { id: '2-2-sign-4', text: 'Nước thoát chậm, có mùi hôi', isIssue: true }
                        ],
                        symptoms: [
                            { id: '2-2-symptom-1', text: 'Gây ẩm mốc tường, sàn', isIssue: true },
                            { id: '2-2-symptom-2', text: 'Tăng chi phí nước bất thường', isIssue: true }
                        ]
                    },
                    {
                        id: '2-3', title: 'Cổng/đường dây lắp sẵn',
                        note: `<strong>Thành phần:</strong> Đầu chờ máy lạnh, máy giặt, bếp, mạng, TV.<br><span class="legal-ref"><strong>Căn cứ pháp lý:</strong> Phụ lục 1 HĐMB.</span>`,
                        signs: [
                            { id: '2-3-sign-1', text: 'Cổng điện không có điện, sai pha', isIssue: true },
                            { id: '2-3-sign-2', text: 'Ống đồng máy lạnh bị bẹp, gãy', isIssue: true },
                            { id: '2-3-sign-3', text: 'Đầu cấp nước máy giặt rỉ nước', isIssue: true },
                            { id: '2-3-sign-4', text: 'Ống thoát nước máy giặt tắc', isIssue: true },
                            { id: '2-3-sign-5', text: 'Ổ cắm bếp bị lỏng, nóng', isIssue: true },
                            { id: '2-3-sign-6', text: 'Cổng mạng/TV không có tín hiệu', isIssue: true }
                        ],
                        symptoms: [
                            { id: '2-3-symptom-1', text: 'Không lắp được thiết bị', isIssue: true },
                            { id: '2-3-symptom-2', text: 'Hỏng thiết bị (rò gas, chập điện)', isIssue: true },
                            { id: '2-3-symptom-3', text: 'Ngập sàn, ẩm mốc', isIssue: true }
                        ]
                    }
                ]
            }
        ];

        const container = document.getElementById('checklist-container');
        let state = {}; 
        let customItems = {};
        let currentStream;
        let photoForItem = {};
        
        let mediaRecorder;
        let recordedChunks = [];
        let isRecording = false;
        let timerInterval;

        let currentGallery = [];
        let currentImageIndex = 0;

        function sanitizeForFilename(str) {
            if (!str) return '';
            const a = 'àáâãèéêìíòóôõùúăđĩũơưăạảấầ̉ẫậắằẳẵặẹẻẽếềểễệỉịọỏốồổỗộớờởỡợụủứừửữựỳýỵỷỹ';
            const b = 'aaaaaeeeiioooouuadiuouaaaaaaaaaaaaaaaeeeeeeeeeeiiooooooooooooooooouuuuuuuuuuyyyyy';
            let result = str.toLowerCase();
            for (let i = 0; i < a.length; i++) {
                result = result.replace(new RegExp(a[i], 'g'), b[i]);
            }
            return result.replace(/[^a-z0-9_]/g, '_').replace(/_+/g, '_').replace(/^_|_$/g, '');
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function safeText(text) {
            if (!text) return '';
            // Remove any potentially problematic characters
            return text.replace(/[<>]/g, '').trim();
        }

        function renderChecklist() {
            let totalItems = 0;
            let checkedItems = 0;
            container.innerHTML = '';

            const combinedData = getCombinedData();

            const countItems = (item) => {
                if (item.isIssue) {
                    totalItems++;
                    if (state[item.id] && state[item.id].checked) {
                        checkedItems++;
                    }
                }
            };
            
            combinedData.forEach(section => {
                section.items.forEach(item => {
                    const allCheckItems = [];
                    if (item.signs) allCheckItems.push(...item.signs);
                    if (item.symptoms) allCheckItems.push(...item.symptoms);
                    allCheckItems.forEach(countItems);
                });
            });

            combinedData.forEach(section => {
                const sectionDiv = document.createElement('details');
                sectionDiv.className = 'bg-white rounded-xl shadow-md overflow-hidden';
                sectionDiv.open = true;

                const summary = document.createElement('summary');
                summary.className = 'p-3 sm:p-4 md:p-5 cursor-pointer flex justify-between items-center bg-gray-50 hover:bg-gray-100 transition-colors';
                summary.innerHTML = `<h2 class="text-base sm:text-lg md:text-xl font-bold text-gray-800 pr-2">${section.title}</h2><svg class="w-5 h-5 sm:w-6 sm:h-6 text-gray-500 arrow transition-transform flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>`;
                sectionDiv.appendChild(summary);

                const contentDiv = document.createElement('div');
                contentDiv.className = 'p-3 sm:p-4 md:p-5 border-t border-gray-200 divide-y divide-gray-200';
                
                section.items.forEach(item => {
                    contentDiv.appendChild(createChecklistGroup(section, item));
                });
                sectionDiv.appendChild(contentDiv);
                container.appendChild(sectionDiv);
            });
            updateProgress(checkedItems, totalItems);
        }
        
        function getCombinedData() {
            // Deep copy to avoid modifying the original checklistData
            const combined = JSON.parse(JSON.stringify(checklistData));
            for (const itemId in customItems) {
                const itemRef = combined.flatMap(s => s.items).find(i => i.id === itemId);
                if (itemRef) {
                    // Gộp tất cả custom items vào signs để tương thích với cấu trúc hiện tại
                    if (customItems[itemId].checkitems) {
                        if (!itemRef.signs) itemRef.signs = [];
                        itemRef.signs.push(...customItems[itemId].checkitems);
                    }
                    // Giữ lại xử lý cho signs và symptoms cũ để tương thích ngược
                    if (customItems[itemId].signs) {
                        if (!itemRef.signs) itemRef.signs = [];
                        itemRef.signs.push(...customItems[itemId].signs);
                    }
                    if (customItems[itemId].symptoms) {
                        if (!itemRef.signs) itemRef.signs = [];
                        itemRef.signs.push(...customItems[itemId].symptoms);
                    }
                }
            }
            return combined;
        }

        function createChecklistGroup(section, item) {
            const groupDiv = document.createElement('div');
            groupDiv.className = 'py-3 sm:py-4';
            
            let checkItemsHtml = '';
            const allCheckItems = [];
            
            // Gộp tất cả signs và symptoms thành một danh sách "Cần kiểm tra"
            if (item.signs && item.signs.length > 0) {
                allCheckItems.push(...item.signs);
            }
            if (item.symptoms && item.symptoms.length > 0) {
                allCheckItems.push(...item.symptoms);
            }
            
            if (allCheckItems.length > 0) {
                checkItemsHtml += '<h4 class="font-semibold text-gray-800 mt-3 mb-2">Cần kiểm tra:</h4>';
                allCheckItems.forEach(checkItem => {
                    checkItemsHtml += createDetailItem(section, item, checkItem);
                });
            }
            
            const addCheckItemHtml = `
                <div class="mt-2 add-check-item-form">
                    <div class="flex items-center space-x-2">
                        <input type="text" id="input-checkitems-${item.id}" class="w-full p-1.5 border rounded-md text-sm" placeholder="Thêm mục kiểm tra khác...">
                        <button onclick="addCustomDetail('${item.id}', 'checkitems')" class="px-3 py-1.5 bg-blue-500 text-white rounded-md text-sm font-semibold hover:bg-blue-600">Thêm</button>
                    </div>
                </div>`;

            groupDiv.innerHTML = `
                <h3 class="text-base sm:text-lg font-bold text-gray-900 mb-2">${item.title}</h3>
                ${item.note ? `<div class="note text-sm mt-2 p-3 rounded-md bg-gray-50 border-l-4 border-gray-300 text-gray-700">${item.note}</div>` : ''}
                <div class="pl-2 sm:pl-4 mt-3">
                    ${checkItemsHtml}
                    ${addCheckItemHtml}
                </div>
            `;
            return groupDiv;
        }

        function createDetailItem(section, item, detail) {
            const itemState = state[detail.id] || { checked: false, media: [], note: '' };
            const isChecked = itemState.checked;
            const hasNote = itemState.note && itemState.note.trim() !== '';
            const hasMedia = itemState.media && itemState.media.length > 0;

            let mediaSectionHtml = '<div class="mt-3 pl-4 sm:pl-8 thumbnail-container">';
            if (hasMedia) {
                mediaSectionHtml += '<div class="flex flex-wrap gap-2 sm:gap-3 items-center">';
                itemState.media.forEach((mediaFile, index) => {
                    const playIcon = mediaFile.type === 'video' ? `<div class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-20 rounded-md"><svg class="w-4 h-4 sm:w-6 sm:h-6 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"></path></svg></div>` : '';
                    
                    // Escape quotes trong filename để tránh lỗi JavaScript
                    const safeFilename = mediaFile.filename.replace(/'/g, "\\'").replace(/"/g, '\\"');
                    
                    mediaSectionHtml += `
                        <div class="relative group">
                            <img src="${mediaFile.thumbnail}" 
                                 onclick="showMediaPreview('${detail.id}', '${safeFilename}')" 
                                 class="h-12 w-12 sm:h-16 sm:w-16 rounded-lg object-cover cursor-pointer shadow-md hover:shadow-xl transition-shadow" 
                                 alt="${mediaFile.filename}">
                            ${playIcon}
                            <button onclick="deleteMedia('${detail.id}', '${safeFilename}'); event.stopPropagation();" 
                                    class="delete-btn absolute -top-1 -right-1 bg-red-500 hover:bg-red-600 text-white rounded-full h-4 w-4 sm:h-5 sm:w-5 flex items-center justify-center text-xs font-bold opacity-0 group-hover:opacity-100 transition-all duration-200 shadow-md" 
                                    title="Xóa ${mediaFile.type === 'video' ? 'video' : 'hình ảnh'} này">
                                ×
                            </button>
                        </div>
                    `;
                });
                mediaSectionHtml += '</div>';
            }
            mediaSectionHtml += '</div>';

            // Ghi chú section - chia thành hai phần
            const noteButtonHtml = !hasNote ? `<button id="note-btn-${detail.id}" onclick="showNoteTextarea('${detail.id}')" class="text-sm text-green-600 hover:text-green-800 font-medium bg-green-50 hover:bg-green-100 px-2 py-1 rounded-md transition-colors note-add-button">+ Thêm ghi chú</button>` : '';
            const noteTextareaHtml = `
                <div class="mt-3 pl-4 sm:pl-8 ${hasNote ? 'bg-yellow-50 border-l-2 border-yellow-400 pl-2 py-2 rounded-md' : ''}">
                    <textarea id="note-${detail.id}" placeholder="Thêm ghi chú..." 
                              class="w-full p-2 text-sm border rounded-md resize-none focus:ring-2 focus:ring-green-500 focus:border-green-500 ${!hasNote ? 'hidden' : ''}" 
                              rows="2" 
                              oninput="updateNote('${detail.id}', this.value)">${itemState.note || ''}</textarea>
                    <div id="note-status-${detail.id}">${hasNote ? '<div class="text-xs text-green-600 mt-2 font-medium">✓ Có ghi chú</div>' : ''}</div>
                </div>
            `;

            // Tạo indicators cho trạng thái
            const statusIndicators = [];
            if (isChecked) statusIndicators.push('<span class="text-green-600 text-sm font-semibold" title="Đã kiểm tra">✓ Đã kiểm tra</span>');
            if (hasNote) statusIndicators.push('<span class="text-orange-600 text-sm font-medium" title="Có ghi chú">📝 Ghi chú</span>');
            if (hasMedia) statusIndicators.push('<span class="text-purple-600 text-sm font-medium" title="Có hình ảnh/video">📷 Hình ảnh</span>');

            return `
                <div class="checklist-item py-3 ${isChecked ? 'checked' : ''}" data-detail-id="${detail.id}">
                    <!-- Mobile Layout (< md screens) -->
                    <div class="md:hidden">
                        <div class="flex items-start space-x-3 mb-2">
                            <input type="checkbox" id="${detail.id}" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 cursor-pointer flex-shrink-0 mt-0.5" onchange="handleCheck('${detail.id}', this.checked)" ${isChecked ? 'checked' : ''}>
                            <label for="${detail.id}" class="text-gray-800 cursor-pointer flex-1 text-sm leading-5">${safeText(detail.text)}</label>
                        </div>
                        <div class="flex items-center justify-between pl-7">
                            ${statusIndicators.length > 0 ? `<div class="flex flex-wrap items-center gap-1 status-indicators">${statusIndicators.map(indicator => `<span class="text-xs">${indicator}</span>`).join('')}</div>` : '<div class="status-indicators"></div>'}
                            <button onclick="openCameraModal('${section.id}', '${item.id}', '${detail.id}', '${detail.text}')" title="Thêm hình ảnh/video" class="p-2 bg-blue-100 text-blue-600 rounded-full hover:bg-blue-200 flex-shrink-0 action-buttons transition-all duration-200 hover:shadow-md">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Desktop Layout (>= md screens) -->
                    <div class="hidden md:flex items-center justify-between">
                        <div class="flex items-center space-x-3 flex-1 min-w-0">
                            <input type="checkbox" id="${detail.id}-desktop" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 cursor-pointer flex-shrink-0" onchange="handleCheck('${detail.id}', this.checked)" ${isChecked ? 'checked' : ''}>
                            <label for="${detail.id}-desktop" class="text-gray-800 cursor-pointer flex-1 truncate">${safeText(detail.text)}</label>
                        </div>
                        <div class="flex items-center space-x-3 flex-shrink-0 ml-4">
                            ${statusIndicators.length > 0 ? `<div class="flex items-center space-x-2 status-indicators">${statusIndicators.join(' ')}</div>` : '<div class="status-indicators"></div>'}
                            <button onclick="openCameraModal('${section.id}', '${item.id}', '${detail.text}')" title="Thêm hình ảnh/video" class="p-1.5 bg-blue-100 text-blue-600 rounded-full hover:bg-blue-200 transition-all duration-200 hover:shadow-md action-buttons">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                            </button>
                        </div>
                    </div>
                    ${!hasMedia && noteButtonHtml ? `<div class="mt-3 pl-4 sm:pl-8">${noteButtonHtml}</div>` : ''}
                    ${mediaSectionHtml}
                    ${hasMedia && noteButtonHtml ? `<div class="mt-3 pl-4 sm:pl-8">${noteButtonHtml}</div>` : ''}
                    ${noteTextareaHtml}
                </div>
            `;
        }
        
        function addCustomDetail(itemId, type) {
            const inputId = `input-${type}-${itemId}`;
            const input = document.getElementById(inputId);
            const text = input.value.trim();
            
            if (!text) {
                alert('Vui lòng nhập nội dung.');
                return;
            }
            
            if (!customItems[itemId]) {
                customItems[itemId] = { checkitems: [] };
            }
            if (!customItems[itemId].checkitems) {
                 customItems[itemId].checkitems = [];
            }
            
            const newDetail = {
                id: `${itemId}-custom-checkitems-${Date.now()}`,
                text: text,
                isIssue: true
            };
            
            customItems[itemId].checkitems.push(newDetail);
            localStorage.setItem('customChecklistItems', JSON.stringify(customItems));
            
            input.value = '';
            renderChecklist();
        }

        function handleCheck(id, isChecked) {
            if (!state[id]) {
                state[id] = { checked: false, media: [], note: '' };
            }
            state[id].checked = isChecked;
            localStorage.setItem('checklistState', JSON.stringify(state));
            
            // Sync both mobile and desktop checkboxes
            const mobileCheckbox = document.getElementById(id);
            const desktopCheckbox = document.getElementById(id + '-desktop');
            if (mobileCheckbox && mobileCheckbox.checked !== isChecked) {
                mobileCheckbox.checked = isChecked;
            }
            if (desktopCheckbox && desktopCheckbox.checked !== isChecked) {
                desktopCheckbox.checked = isChecked;
            }
            
            renderChecklist();
        }

        function updateNote(id, noteText) {
            if (!state[id]) {
                state[id] = { checked: false, media: [], note: '' };
            }
            const oldNote = state[id].note;
            state[id].note = noteText.trim();
            localStorage.setItem('checklistState', JSON.stringify(state));
            
            // Chỉ cập nhật status indicators và progress nếu có thay đổi
            if (oldNote !== noteText.trim()) {
                updateStatusIndicators(id);
                updateProgressOnly();
            }
        }
        
        function updateStatusIndicators(detailId) {
            const itemState = state[detailId];
            if (!itemState) return;
            
            const hasNote = itemState.note && itemState.note.trim() !== '';
            const hasMedia = itemState.media && itemState.media.length > 0;
            const isChecked = itemState.checked;
            
            // Tìm tất cả status indicators cho item này
            const statusContainers = document.querySelectorAll(`[data-detail-id="${detailId}"] .status-indicators`);
            
            statusContainers.forEach(container => {
                const statusIndicators = [];
                if (isChecked) statusIndicators.push('<span class="text-green-600 text-sm font-semibold" title="Đã kiểm tra">✓ Đã kiểm tra</span>');
                if (hasNote) statusIndicators.push('<span class="text-orange-600 text-sm font-medium" title="Có ghi chú">📝 Ghi chú</span>');
                if (hasMedia) statusIndicators.push('<span class="text-purple-600 text-sm font-medium" title="Có hình ảnh/video">📷 Hình ảnh</span>');
                
                container.innerHTML = statusIndicators.length > 0 ? statusIndicators.join(' ') : '';
            });
            
            // Cập nhật background highlight cho phần ghi chú thay vì toàn bộ item
            // Tìm đúng div chứa textarea ghi chú
            const noteTextarea = document.getElementById(`note-${detailId}`);
            if (noteTextarea) {
                const noteDiv = noteTextarea.closest('.mt-3');
                if (noteDiv) {
                    if (hasNote) {
                        noteDiv.classList.add('bg-yellow-50', 'border-l-2', 'border-yellow-400', 'pl-2', 'py-2', 'rounded-md');
                    } else {
                        noteDiv.classList.remove('bg-yellow-50', 'border-l-2', 'border-yellow-400', 'pl-2', 'py-2', 'rounded-md');
                    }
                }
            }
            
            // Cập nhật hiển thị note status
            const noteStatusDiv = document.getElementById(`note-status-${detailId}`);
            if (noteStatusDiv) {
                if (hasNote) {
                    noteStatusDiv.innerHTML = '<div class="text-xs text-green-600 mt-2 font-medium">✓ Có ghi chú</div>';
                } else {
                    noteStatusDiv.innerHTML = '';
                }
            }
        }
        
        function updateProgressOnly() {
            let totalItems = 0;
            let checkedItems = 0;
            
            const combinedData = getCombinedData();
            const countItems = (item) => {
                if (item.isIssue) {
                    totalItems++;
                    if (state[item.id] && state[item.id].checked) {
                        checkedItems++;
                    }
                }
            };
            
            combinedData.forEach(section => {
                section.items.forEach(item => {
                    const allCheckItems = [];
                    if (item.signs) allCheckItems.push(...item.signs);
                    if (item.symptoms) allCheckItems.push(...item.symptoms);
                    allCheckItems.forEach(countItems);
                });
            });
            
            updateProgress(checkedItems, totalItems);
        }

        function showNoteTextarea(id) {
            const textarea = document.getElementById(`note-${id}`);
            const button = document.getElementById(`note-btn-${id}`);
            
            if (textarea && button) {
                button.style.display = 'none';
                textarea.classList.remove('hidden');
                textarea.focus();
            }
        }
        
        function deleteMedia(detailId, filename) {
            if (!state[detailId] || !state[detailId].media) {
                console.warn('Không tìm thấy media để xóa');
                return;
            }

            // Tìm file cần xóa
            const mediaIndex = state[detailId].media.findIndex(m => m.filename === filename);
            if (mediaIndex === -1) {
                console.warn('Không tìm thấy file:', filename);
                return;
            }

            // Xác nhận trước khi xóa
            if (!confirm(`Bạn có chắc muốn xóa file "${filename}"?`)) {
                return;
            }

            const mediaFile = state[detailId].media[mediaIndex];
            
            // Giải phóng URL nếu là video
            if (mediaFile.type === 'video' && mediaFile.dataUrl.startsWith('blob:')) {
                URL.revokeObjectURL(mediaFile.dataUrl);
            }
            
            // Xóa chỉ file được chọn
            state[detailId].media.splice(mediaIndex, 1);
            
            // Lưu state và render lại
            localStorage.setItem('checklistState', JSON.stringify(state));
            renderChecklist();
            
            console.log(`Đã xóa file: ${filename}`);
        }

        function updateProgress(checked, total) {
            const percentage = total > 0 ? Math.round((checked / total) * 100) : 0;
            document.getElementById('progress-bar').style.width = `${percentage}%`;
            document.getElementById('progress-text').textContent = `${percentage}%`;
            document.getElementById('checked-count').textContent = checked;
            document.getElementById('total-count').textContent = total;
            
            // Tính số vấn đề cần báo cáo (có ghi chú hoặc hình ảnh)
            let reportCount = 0;
            Object.values(state).forEach(itemState => {
                const hasMedia = itemState.media && itemState.media.length > 0;
                const hasNote = itemState.note && itemState.note.trim() !== '';
                // Một mục được tính là vấn đề nếu có ghi chú HOẶC có hình ảnh
                if (hasMedia || hasNote) {
                    reportCount++;
                }
            });
            
            document.getElementById('report-count').textContent = `${reportCount} vấn đề`;
        }
        
        function confirmDownloadZip() {
            const allMedia = [];
            for (const detailId in state) {
                if (state[detailId].media && state[detailId].media.length > 0) {
                    allMedia.push(...state[detailId].media);
                }
            }

            if (allMedia.length === 0) {
                alert('Không có hình ảnh/video nào để tải xuống.');
                return;
            }

            const message = `Bạn có muốn tải xuống ${allMedia.length} file hình ảnh/video thành file ZIP không?`;
            if (confirm(message)) {
                downloadAllMediaAsZip();
            }
        }
        
        function printChecklist() { 
            if (confirm('Bạn có muốn in checklist không? Các form nhập liệu sẽ được ẩn khi in.')) {
                window.print(); 
            }
        }
        
        async function downloadAllMediaAsZip() {
            const zipBtn = document.getElementById('zip-btn');
            const zipStatus = document.getElementById('zip-status');

            const allMedia = [];
            for (const detailId in state) {
                if (state[detailId].media && state[detailId].media.length > 0) {
                    allMedia.push(...state[detailId].media);
                }
            }

            if (allMedia.length === 0) {
                alert('Không có hình ảnh/video nào để tải xuống.');
                return;
            }

            zipBtn.disabled = true;
            zipBtn.classList.add('opacity-50', 'cursor-not-allowed');
            zipStatus.textContent = 'Đang chuẩn bị file...';
            zipStatus.classList.remove('hidden');

            try {
                const zip = new JSZip();
                const promises = [];

                allMedia.forEach((media) => {
                    if (media.type === 'image') {
                        const base64Data = media.dataUrl.split(',')[1];
                        promises.push(Promise.resolve({ name: media.filename, data: base64Data, options: { base64: true } }));
                    } else if (media.type === 'video') {
                        const promise = fetch(media.dataUrl)
                            .then(response => response.blob())
                            .then(blob => ({ name: media.filename, data: blob, options: {} }));
                        promises.push(promise);
                    }
                });

                const files = await Promise.all(promises);
                
                files.forEach(file => {
                    zip.file(file.name, file.data, file.options);
                });

                zipStatus.textContent = 'Đang nén file ZIP...';
                const content = await zip.generateAsync({
                    type: "blob",
                    compression: "DEFLATE",
                    compressionOptions: {
                        level: 9
                    }
                }, (metadata) => {
                    zipStatus.textContent = `Đang nén: ${Math.round(metadata.percent)}%`;
                });

                const timestamp = new Date().toISOString().slice(0, 10).replace(/-/g, '');
                saveAs(content, `GoldenCity_BangChung_${timestamp}.zip`);

            } catch (error) {
                console.error("Lỗi khi tạo file ZIP:", error);
                alert("Đã xảy ra lỗi khi tạo file ZIP. Vui lòng thử lại.");
                zipStatus.textContent = 'Đã xảy ra lỗi!';
            } finally {
                zipBtn.disabled = false;
                zipBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                zipStatus.textContent = 'Hoàn tất!';
                setTimeout(() => {
                    zipStatus.classList.add('hidden');
                }, 3000);
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
            if (modalId === 'image-preview-modal') {
                window.removeEventListener('keydown', handleKeyPress);
                const video = document.getElementById('preview-video');
                video.pause();
                video.src = '';
            }
        }

        async function openCameraModal(sectionId, itemId, detailId, detailText) {
            const section = checklistData.find(s => s.id === sectionId);
            const item = section.items.find(i => i.id === itemId);
           
            photoForItem = {
                sectionId: section.id,
                itemTitle: item.title,
                detailText: detailText,
                detailId: detailId
            };
            
            const cameraModal = document.getElementById('camera-modal');
            const video = document.getElementById('camera-stream');
            const captureBtn = document.getElementById('capture-btn');
            const recordBtn = document.getElementById('record-btn');
            const loadingDiv = document.getElementById('camera-loading');
            
            // Show modal and reset button states
            cameraModal.classList.remove('hidden');
            captureBtn.disabled = true;
            recordBtn.disabled = true;
            loadingDiv.classList.remove('hidden');
            
            try {
                if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                    currentStream = await navigator.mediaDevices.getUserMedia({ 
                        video: { 
                            facingMode: 'environment',
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        }, 
                        audio: true 
                    });
                    
                    video.srcObject = currentStream;
                    
                    // Wait for video to be ready
                    await new Promise((resolve, reject) => {
                        video.onloadedmetadata = () => {
                            video.play().then(resolve).catch(reject);
                        };
                        video.onerror = reject;
                        
                        // Timeout after 10 seconds
                        setTimeout(() => reject(new Error('Camera timeout')), 10000);
                    });
                    
                    // Camera is ready, enable buttons and hide loading
                    loadingDiv.classList.add('hidden');
                    captureBtn.disabled = false;
                    recordBtn.disabled = false;
                    document.getElementById('record-btn-text').textContent = 'Bắt đầu Quay';
                    isRecording = false;
                    
                } else {
                    throw new Error('Trình duyệt không hỗ trợ truy cập camera');
                }
            } catch (err) {
                console.error("Error accessing camera: ", err);
                loadingDiv.innerHTML = `
                    <div class="text-white text-center">
                        <svg class="w-8 h-8 mx-auto mb-2 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L5.082 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                        </svg>
                        <p class="text-sm">Không thể truy cập camera</p>
                        <p class="text-xs mt-1">Vui lòng cấp quyền và thử lại</p>
                    </div>
                `;
                
                setTimeout(() => {
                    closeCamera();
                }, 3000);
            }
        }
        
        function closeCamera() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
            if (isRecording && mediaRecorder) {
                mediaRecorder.stop();
            }
            clearInterval(timerInterval);
            
            // Reset UI elements
            const timerDiv = document.getElementById('timer');
            const loadingDiv = document.getElementById('camera-loading');
            const captureBtn = document.getElementById('capture-btn');
            const recordBtn = document.getElementById('record-btn');
            const recordBtnText = document.getElementById('record-btn-text');
            const video = document.getElementById('camera-stream');
            
            timerDiv.classList.add('hidden');
            loadingDiv.classList.add('hidden');
            captureBtn.disabled = true;
            recordBtn.disabled = true;
            recordBtnText.textContent = 'Bắt đầu Quay';
            recordBtn.classList.remove('bg-red-600');
            recordBtn.classList.add('bg-red-500');
            video.srcObject = null;
            
            isRecording = false;
            document.getElementById('camera-modal').classList.add('hidden');
        }

        function capturePhoto() {
            const canvas = document.getElementById('camera-canvas');
            const video = document.getElementById('camera-stream');
            const context = canvas.getContext('2d');
            
            // Ensure video is ready
            if (video.videoWidth === 0 || video.videoHeight === 0) {
                alert('Camera chưa sẵn sàng. Vui lòng thử lại sau vài giây.');
                return;
            }
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, video.videoWidth, video.videoHeight);
            
            const dataUrl = canvas.toDataURL('image/jpeg', 0.9);
            const filename = generateFilename('jpg');
            
            saveMedia({ type: 'image', filename, dataUrl, thumbnail: dataUrl });
            
            // Show success feedback
            const captureBtn = document.getElementById('capture-btn');
            const originalText = captureBtn.innerHTML;
            captureBtn.innerHTML = '<span class="flex items-center"><svg class="w-4 h-4 mr-2 text-green-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>Đã chụp!</span>';
            
            setTimeout(() => {
                captureBtn.innerHTML = originalText;
                closeCamera();
            }, 1000);
        }

        function toggleRecording() {
            const recordBtn = document.getElementById('record-btn');
            const recordBtnText = document.getElementById('record-btn-text');
            const captureBtn = document.getElementById('capture-btn');
            const timerDiv = document.getElementById('timer');

            if (!currentStream || !currentStream.active) {
                alert("Lỗi: Không tìm thấy tín hiệu camera. Vui lòng thử mở lại cửa sổ ghi nhận.");
                return;
            }

            if (isRecording) {
                // Stop recording
                mediaRecorder.stop();
                recordBtnText.textContent = 'Bắt đầu Quay';
                recordBtn.classList.remove('bg-red-600');
                recordBtn.classList.add('bg-red-500');
                captureBtn.disabled = false;
                isRecording = false;
                clearInterval(timerInterval);
                timerDiv.classList.add('hidden');
            } else {
                // Start recording
                recordedChunks = [];
                try {
                    const options = { mimeType: 'video/webm;codecs=vp9' };
                    if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                        options.mimeType = 'video/webm;codecs=vp8';
                        if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                            options.mimeType = 'video/webm';
                        }
                    }
                    mediaRecorder = new MediaRecorder(currentStream, options);
                } catch (e) {
                    console.error("Error creating MediaRecorder:", e);
                    alert("Không thể tạo trình ghi video. Trình duyệt của bạn có thể không hỗ trợ định dạng này.");
                    return;
                }

                mediaRecorder.ondataavailable = event => {
                    if (event.data.size > 0) {
                        recordedChunks.push(event.data);
                    }
                };
                
                mediaRecorder.onstop = () => {
                    const blob = new Blob(recordedChunks, { type: 'video/webm' });
                    const videoUrl = URL.createObjectURL(blob);
                    
                    const video = document.createElement('video');
                    video.src = videoUrl;
                    video.onloadeddata = () => {
                        const canvas = document.getElementById('camera-canvas');
                        canvas.width = video.videoWidth;
                        canvas.height = video.videoHeight;
                        canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
                        const thumbnailUrl = canvas.toDataURL('image/jpeg');
                        
                        const filename = generateFilename('webm');
                        saveMedia({ type: 'video', filename, dataUrl: videoUrl, thumbnail: thumbnailUrl });
                        
                        // Show success feedback
                        recordBtnText.textContent = 'Đã lưu video!';
                        setTimeout(() => {
                            closeCamera();
                        }, 1000);
                    };
                };

                mediaRecorder.start();
                recordBtnText.textContent = 'Dừng Quay';
                recordBtn.classList.remove('bg-red-500');
                recordBtn.classList.add('bg-red-600');
                captureBtn.disabled = true;
                isRecording = true;
                
                let seconds = 0;
                timerDiv.classList.remove('hidden');
                timerDiv.textContent = '00:00';
                timerInterval = setInterval(() => {
                    seconds++;
                    const min = Math.floor(seconds / 60).toString().padStart(2, '0');
                    const sec = (seconds % 60).toString().padStart(2, '0');
                    timerDiv.textContent = `${min}:${sec}`;
                }, 1000);
            }
        }
        
        function generateFilename(extension) {
            const sectionName = sanitizeForFilename(photoForItem.sectionId);
            const itemName = sanitizeForFilename(photoForItem.itemTitle);
            const detailName = sanitizeForFilename(photoForItem.detailText);
            return `${sectionName}_${itemName}_${detailName}.${extension}`;
        }
        
        function saveMedia(mediaObject) {
            const detailId = photoForItem.detailId;
            if (!state[detailId]) {
                state[detailId] = { checked: false, media: [], note: '' };
            }
            state[detailId].media.push(mediaObject);
            localStorage.setItem('checklistState', JSON.stringify(state));
            renderChecklist();
        }

        function showMediaPreview(detailId, filename) {
            const itemState = state[detailId];
            if (!itemState || !itemState.media || itemState.media.length === 0) return;
            currentGallery = itemState.media;
            currentImageIndex = currentGallery.findIndex(m => m.filename === filename);
            if (currentImageIndex === -1) return;
            
            document.getElementById('image-preview-modal').classList.remove('hidden');
            window.addEventListener('keydown', handleKeyPress);
            updatePreviewContent();
        }

        function updatePreviewContent() {
            if (currentGallery.length === 0) {
                closeModal('image-preview-modal');
                return;
            }
            if (currentImageIndex < 0) currentImageIndex = 0;
            if (currentImageIndex >= currentGallery.length) currentImageIndex = currentGallery.length - 1;

            const mediaFile = currentGallery[currentImageIndex];
            const previewImage = document.getElementById('preview-image');
            const previewVideo = document.getElementById('preview-video');
            const galleryThumbs = document.getElementById('gallery-thumbnails');

            galleryThumbs.innerHTML = '';
            currentGallery.forEach((file, index) => {
                const playIcon = file.type === 'video' ? `<div class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-30"><svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20"><path d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z"></path></svg></div>` : '';
                const thumbDiv = document.createElement('div');
                thumbDiv.className = `gallery-thumbnail relative h-16 w-16 rounded-md cursor-pointer border-2 ${index === currentImageIndex ? 'border-blue-500' : 'border-transparent'}`;
                thumbDiv.innerHTML = `<img src="${file.thumbnail}" class="h-full w-full object-cover rounded-md">${playIcon}`;
                thumbDiv.onclick = () => {
                    currentImageIndex = index;
                    updatePreviewContent();
                };
                galleryThumbs.appendChild(thumbDiv);
            });


            if (mediaFile.type === 'image') {
                previewImage.src = mediaFile.dataUrl;
                previewImage.classList.remove('hidden');
                previewVideo.classList.add('hidden');
                previewVideo.pause();
                previewVideo.src = '';
            } else { 
                previewVideo.src = mediaFile.dataUrl;
                previewVideo.classList.remove('hidden');
                previewImage.classList.add('hidden');
                previewImage.src = '';
            }

            const prevBtn = document.getElementById('prev-image-btn');
            const nextBtn = document.getElementById('next-image-btn');

            if (currentGallery.length > 1) {
                prevBtn.classList.remove('hidden');
                nextBtn.classList.remove('hidden');
                prevBtn.disabled = currentImageIndex === 0;
                nextBtn.disabled = currentImageIndex === currentGallery.length - 1;
            } else {
                prevBtn.classList.add('hidden');
                nextBtn.classList.add('hidden');
            }
        }
        
        function navigateGallery(direction) {
            const newIndex = currentImageIndex + direction;
            if (newIndex >= 0 && newIndex < currentGallery.length) {
                currentImageIndex = newIndex;
                updatePreviewContent();
            }
        }
        
        function handleKeyPress(event) {
            if (event.key === 'ArrowLeft') {
                navigateGallery(-1);
            } else if (event.key === 'ArrowRight') {
                navigateGallery(1);
            } else if (event.key === 'Escape') {
                closeModal('image-preview-modal');
            }
        }

        function openDraftEmailModal() {
            const issuesListDiv = document.getElementById('issues-list');
            issuesListDiv.innerHTML = '';
            const detectedIssues = [];

            // Tìm các mục có ghi chú hoặc hình ảnh (không phụ thuộc vào checkbox)
            const findItemsWithNotes = (detail) => {
                const itemState = state[detail.id];
                const hasMedia = itemState && itemState.media && itemState.media.length > 0;
                const hasNote = itemState && itemState.note && itemState.note.trim() !== '';
                
                // Chỉ thêm vào danh sách nếu có ghi chú hoặc hình ảnh
                if (hasMedia || hasNote) {
                    // Ngăn trùng lặp
                    if (!detectedIssues.some(issue => issue.id === detail.id)) {
                        detectedIssues.push({
                            id: detail.id, 
                            text: detail.text,
                            hasMedia: hasMedia,
                            hasNote: hasNote,
                            isChecked: itemState && itemState.checked // Trạng thái checkbox riêng biệt
                        });
                    }
                }
            };

            getCombinedData().forEach(section => {
                section.items.forEach(item => {
                    const allCheckItems = [];
                    if (item.signs) allCheckItems.push(...item.signs);
                    if (item.symptoms) allCheckItems.push(...item.symptoms);
                    allCheckItems.forEach(findItemsWithNotes);
                });
            });
            
            if (detectedIssues.length === 0) {
                issuesListDiv.innerHTML = '<p class="text-gray-500 italic">Chưa có mục nào có ghi chú hoặc hình ảnh để đưa vào báo cáo.</p>';
            } else {
                detectedIssues.forEach(issue => {
                    const mediaIcon = issue.hasMedia ? '<span class="text-blue-500 ml-2" title="Có hình ảnh/video">📷</span>' : '';
                    const noteIcon = issue.hasNote ? '<span class="text-green-500 ml-1" title="Có ghi chú">📝</span>' : '';
                    const checkedStatus = issue.isChecked ? '<span class="text-gray-500 ml-2" title="Đã kiểm tra">✓</span>' : '';
                    
                    issuesListDiv.innerHTML += `
                        <label class="flex items-center space-x-3 p-2 rounded border hover:bg-gray-50">
                            <input type="checkbox" name="issue" value="${issue.text}" class="form-checkbox h-5 w-5 text-blue-600" checked>
                            <span class="text-gray-700 flex-1">${issue.text}</span>
                            <div class="flex items-center">
                                ${checkedStatus}
                                ${noteIcon}
                                ${mediaIcon}
                            </div>
                        </label>
                    `;
                });
            }
            
            document.getElementById('gemini-modal').classList.remove('hidden');
            document.getElementById('gemini-result-container').classList.add('hidden');
            document.getElementById('gemini-loader').classList.add('hidden');
        }

        async function generateEmail() {
            const selectedIssuesNodes = document.querySelectorAll('input[name="issue"]:checked');
            const selectedIssues = Array.from(selectedIssuesNodes).map(node => node.value);
            const customIssue = document.getElementById('custom-issue').value;
            if (selectedIssues.length === 0 && !customIssue) {
                alert('Vui lòng chọn ít nhất một vấn đề hoặc nhập yêu cầu của bạn.');
                return;
            }
            const loader = document.getElementById('gemini-loader');
            const resultContainer = document.getElementById('gemini-result-container');
            const resultDiv = document.getElementById('gemini-result');
            loader.classList.remove('hidden');
            resultContainer.classList.add('hidden');
            let prompt = `Bạn là một trợ lý pháp lý cho người mua nhà ở xã hội tại Việt Nam. Hãy soạn một văn bản (dạng đơn khiếu nại hoặc email) trang trọng, lịch sự nhưng kiên quyết để gửi cho Chủ đầu tư dự án Nhà ở xã hội Golden City An Giang. Nội dung cần đề cập các vấn đề sau:\n\n`;
            selectedIssues.forEach(issue => { prompt += `- ${issue}\n`; });
            if(customIssue) { prompt += `- Vấn đề bổ sung: ${customIssue}\n`; }
            prompt += `\nVăn bản cần yêu cầu Chủ đầu tư phản hồi về lộ trình khắc phục các vấn đề trên và thực hiện nghĩa vụ bồi thường chậm bàn giao theo hợp đồng. Cuối thư, hãy ghi rõ thông tin người gửi là "Đại diện các hộ dân mua nhà tại tòa T3, T4" và để trống phần ký tên.`;
            
            try {
                let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                const payload = { contents: chatHistory };
                const apiKey = "AIzaSyB0cKFyBnj5lgusrQOEFoKuOCJ3oxQvCjE";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) { throw new Error(`API call failed with status: ${response.status}`); }
                const result = await response.json();
                if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts) {
                    const text = result.candidates[0].content.parts[0].text;
                    resultDiv.innerHTML = text.replace(/\n/g, '<br>');
                } else {
                   resultDiv.innerText = 'Rất tiếc, đã có lỗi xảy ra. Không nhận được phản hồi hợp lệ từ AI. Vui lòng thử lại.';
                }
            } catch (error) {
                 resultDiv.innerText = `Đã xảy ra lỗi khi kết nối đến Gemini AI. Vui lòng kiểm tra lại. Lỗi: ${error.message}`;
            } finally {
                loader.classList.add('hidden');
                resultContainer.classList.remove('hidden');
            }
        }
        
        function copyToClipboard() {
            const textToCopy = document.getElementById('gemini-result').innerText;
            const tempTextArea = document.createElement('textarea');
            tempTextArea.value = textToCopy;
            document.body.appendChild(tempTextArea);
            tempTextArea.select();
            document.execCommand('copy');
            document.body.removeChild(tempTextArea);
            alert('Đã sao chép nội dung vào bộ nhớ tạm!');
        }

        // Manual toggle function for progress panel
        function toggleProgressPanel() {
            const stickyPanel = document.querySelector('.sticky-progress');
            const toggleIcon = document.getElementById('toggle-icon');
            
            if (stickyPanel.classList.contains('collapsed')) {
                // Expand
                stickyPanel.classList.remove('collapsed');
                localStorage.setItem('progressPanelCollapsed', 'false');
            } else {
                // Collapse
                stickyPanel.classList.add('collapsed');
                localStorage.setItem('progressPanelCollapsed', 'true');
            }
        }

        // Restore panel state from localStorage on page load
        document.addEventListener('DOMContentLoaded', function() {
            const isCollapsed = localStorage.getItem('progressPanelCollapsed') === 'true';
            if (isCollapsed) {
                document.querySelector('.sticky-progress').classList.add('collapsed');
            }
        });

        // Apartment Code Editing Functions
        function editApartmentCode() {
            const display = document.getElementById('apartment-code-display');
            const input = document.getElementById('apartment-code-input');
            
            // Set input value to current display text
            input.value = display.textContent;
            
            // Hide display, show input
            display.classList.add('hidden');
            input.classList.remove('hidden');
            
            // Focus and select all text
            input.focus();
            input.select();
        }

        function saveApartmentCode() {
            const display = document.getElementById('apartment-code-display');
            const input = document.getElementById('apartment-code-input');
            
            // Update display text with input value (or keep original if empty)
            const newCode = input.value.trim() || display.textContent;
            display.textContent = newCode;
            
            // Save to localStorage
            localStorage.setItem('apartmentCode', newCode);
            
            // Hide input, show display
            input.classList.add('hidden');
            display.classList.remove('hidden');
        }

        function handleApartmentCodeKeydown(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                saveApartmentCode();
            } else if (event.key === 'Escape') {
                event.preventDefault();
                // Cancel editing - restore original value
                const display = document.getElementById('apartment-code-display');
                const input = document.getElementById('apartment-code-input');
                input.classList.add('hidden');
                display.classList.remove('hidden');
            }
        }

        // Load saved apartment code on page load
        function loadApartmentCode() {
            const savedCode = localStorage.getItem('apartmentCode');
            if (savedCode) {
                document.getElementById('apartment-code-display').textContent = savedCode;
            }
        }

        // Initial Load
        const savedState = localStorage.getItem('checklistState');
        if (savedState) { state = JSON.parse(savedState); }
        const savedCustomItems = localStorage.getItem('customChecklistItems');
        if(savedCustomItems) { customItems = JSON.parse(savedCustomItems); }
        
        // Load apartment code
        loadApartmentCode();
        
        renderChecklist();
    </script>

</body>
</html>
