<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checklist Ho√†n Ch·ªânh B√†n Giao CƒÉn H·ªô (cho ph√©p t√πy ch·ªânh) - Golden City An Giang</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.0/FileSaver.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        details > summary {
            list-style: none;
        }
        details > summary::-webkit-details-marker {
            display: none;
        }
        details[open] summary .arrow {
            transform: rotate(90deg);
        }
        .checklist-item {
            transition: all 0.2s ease-in-out;
        }
        .checklist-item.checked {
            text-decoration: line-through;
            color: #6b7280;
        }
        .checklist-item.checked .note, .checklist-item.checked .media-list-title {
            text-decoration: none;
            color: #6b7280;
        }
        .sticky-progress {
            position: -webkit-sticky;
            position: sticky;
            top: 0;
            z-index: 50;
            transition: padding 0.4s ease-in-out;
        }
        .action-button {
            transition: all 0.2s ease-in-out;
        }
        .action-button:hover {
            transform: scale(1.1);
        }
        .thumbnail-container .group:hover .delete-btn {
            opacity: 1;
        }
        .nav-button:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        .gallery-thumbnail.active {
            border-color: #3b82f6; /* Tailwind's blue-500 */
        }
        .note ul {
            margin-top: 0.5rem;
        }
        .note strong {
            color: #1f2937;
        }
        .legal-ref {
            display: block;
            margin-top: 8px;
            font-style: italic;
            color: #4b5563;
        }
        /* Styles for collapsible progress panel */
        #collapsible-content {
            max-height: 200px; /* A large enough value to show content */
            transition: max-height 0.4s ease-out, opacity 0.4s ease-out, margin-top 0.4s ease-out;
            opacity: 1;
            overflow: hidden;
        }
        .sticky-progress.collapsed #collapsible-content {
            max-height: 0;
            margin-top: 0;
            opacity: 0;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="container mx-auto max-w-4xl p-4 sm:p-6 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-2xl sm:text-3xl font-bold text-gray-800">CHECKLIST HO√ÄN CH·ªàNH B√ÄN GIAO CƒÇN H·ªò T3.0206A</h1>
            <p class="text-lg text-gray-600 mt-2">D·ª± √°n Nh√† ·ªü x√£ h·ªôi Golden City An Giang</p>
        </header>

        <div class="bg-white rounded-xl shadow-lg p-6 mb-6 sticky-progress">
            <div class="flex justify-between items-center">
                 <h2 class="text-lg font-semibold text-gray-700">Ti·∫øn ƒë·ªô ho√†n th√†nh</h2>
                 <span id="progress-text" class="font-bold text-blue-600">0%</span>
            </div>
            <div id="collapsible-content">
                <div class="w-full bg-gray-200 rounded-full h-2.5 mt-4">
                    <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
                </div>
                <div class="flex justify-end items-center mt-4 space-x-2">
                     <span id="zip-status" class="text-sm text-gray-600 mr-2 hidden"></span>
                     <button onclick="printChecklist()" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg inline-flex items-center text-sm">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path></svg>
                        <span>In Checklist</span>
                    </button>
                    <button id="zip-btn" onclick="downloadAllMediaAsZip()" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg inline-flex items-center text-sm">
                        <svg class="w-4 h-4 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd" />
                        </svg>
                        <span>T·∫£i ZIP B·∫±ng Ch·ª©ng</span>
                    </button>
                     <button onclick="openDraftEmailModal()" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg inline-flex items-center text-sm">
                        <svg class="w-4 h-4 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M2.003 5.884L10 2l7.997 3.884A2 2 0 0019 7.616V16a2 2 0 01-2 2H3a2 2 0 01-2-2V7.616a2 2 0 001.003-1.732zM10 4.268L3.003 7.616l6.997 3.498 6.997-3.498L10 4.268zM3 9.416l6.997 3.498V16H3V9.416zm13.003 0L10 12.914V16h6.997V9.416z"></path></svg>
                        <span>So·∫°n Th·∫£o Email</span>
                    </button>
                </div>
            </div>
        </div>

        <div id="checklist-container" class="space-y-4">
            <!-- Checklist content will be generated by JavaScript -->
        </div>
    </div>
    
    <!-- Gemini Modal -->
    <div id="gemini-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden">
      <div class="relative top-20 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl leading-6 font-bold text-gray-900">‚ú® So·∫°n th·∫£o VƒÉn b·∫£n v·ªõi Gemini AI</h3>
                <button onclick="closeModal('gemini-modal')" class="text-gray-400 hover:text-gray-600 text-3xl font-bold">&times;</button>
            </div>
          <div class="mt-2 px-7 py-3 text-left">
            <p class="text-sm text-gray-600 mb-4">Gemini s·∫Ω gi√∫p b·∫°n so·∫°n th·∫£o m·ªôt vƒÉn b·∫£n/email trang tr·ªçng d·ª±a tr√™n c√°c v·∫•n ƒë·ªÅ b·∫°n ƒë√£ ph√°t hi·ªán. Vui l√≤ng ch·ªçn c√°c n·ªôi dung c·∫ßn ƒë∆∞a v√†o vƒÉn b·∫£n:</p>
            <div id="issues-list" class="space-y-2 mb-4 max-h-48 overflow-y-auto"></div>
            <textarea id="custom-issue" class="w-full h-20 p-2 border rounded-md" placeholder="Th√™m c√°c v·∫•n ƒë·ªÅ kh√°c ho·∫∑c y√™u c·∫ßu c·ª• th·ªÉ c·ªßa b·∫°n ·ªü ƒë√¢y..."></textarea>
            <div id="gemini-result-container" class="mt-4 hidden">
                 <h4 class="font-semibold text-gray-800 mb-2">VƒÉn b·∫£n do Gemini ƒë·ªÅ xu·∫•t:</h4>
                 <div class="w-full p-3 h-64 overflow-y-auto bg-gray-50 rounded-md border text-sm text-gray-800" id="gemini-result"></div>
                 <button onclick="copyToClipboard()" class="mt-2 bg-blue-100 text-blue-700 font-semibold py-1 px-3 rounded-lg text-xs">Sao ch√©p n·ªôi dung</button>
            </div>
             <div id="gemini-loader" class="mt-4 hidden text-center"><p>Gemini ƒëang suy nghƒ©... ‚ú®</p></div>
          </div>
          <div class="items-center px-4 py-3">
            <button id="generate-btn" onclick="generateEmail()" class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-300">T·∫°o VƒÉn b·∫£n</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Camera Modal -->
    <div id="camera-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full z-50 hidden">
      <div class="relative top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 p-5 border w-full max-w-lg shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl leading-6 font-bold text-gray-900">üì∏ Ghi nh·∫≠n b·∫±ng ch·ª©ng</h3>
            <button onclick="closeCamera()" class="text-gray-400 hover:text-gray-600 text-3xl font-bold">&times;</button>
          </div>
          <div class="mt-2 relative">
            <video id="camera-stream" class="w-full h-auto bg-black rounded-md" autoplay playsinline></video>
            <canvas id="camera-canvas" class="hidden"></canvas>
            <div id="timer" class="absolute top-2 right-2 bg-red-600 text-white text-xs font-mono px-2 py-1 rounded-full hidden">00:00</div>
          </div>
          <div class="flex items-center justify-center space-x-4 px-4 py-3">
            <button id="capture-btn" onclick="capturePhoto()" class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md shadow-sm hover:bg-blue-600">Ch·ª•p ·∫£nh</button>
            <button id="record-btn" onclick="toggleRecording()" class="px-4 py-2 bg-red-500 text-white text-base font-medium rounded-md shadow-sm hover:bg-red-600">B·∫Øt ƒë·∫ßu Quay</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Image Preview Modal -->
    <div id="image-preview-modal" class="fixed inset-0 bg-black bg-opacity-80 flex flex-col items-center justify-center z-[60] p-4 hidden">
        <div class="relative w-full max-w-4xl max-h-[80vh] flex items-center justify-center">
             <button id="prev-image-btn" onclick="navigateGallery(-1)" class="nav-button hidden absolute left-0 sm:-left-12 top-1/2 -translate-y-1/2 bg-white bg-opacity-20 hover:bg-opacity-40 text-white p-3 rounded-full transition-opacity">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
            </button>
            <div class="relative max-w-full max-h-full bg-white p-1 rounded-lg shadow-lg">
                <button onclick="closeModal('image-preview-modal')" class="absolute -top-3 -right-3 bg-white rounded-full h-8 w-8 flex items-center justify-center text-gray-700 hover:text-black z-20 text-2xl font-bold">&times;</button>
                <img id="preview-image" src="" alt="Image Preview" class="w-full h-full object-contain rounded-md hidden">
                <video id="preview-video" src="" alt="Video Preview" class="w-full h-full object-contain rounded-md hidden" controls autoplay></video>
            </div>
            <button id="next-image-btn" onclick="navigateGallery(1)" class="nav-button hidden absolute right-0 sm:-right-12 top-1/2 -translate-y-1/2 bg-white bg-opacity-20 hover:bg-opacity-40 text-white p-3 rounded-full transition-opacity">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
            </button>
        </div>
        <div id="gallery-thumbnails" class="mt-4 h-[80px] w-full max-w-4xl flex justify-center items-center gap-2 overflow-x-auto">
             <!-- Thumbnails will be populated here -->
        </div>
    </div>


    <script>
        const checklistData = [
            {
                id: '0_phap-ly-ho-so',
                title: '0Ô∏è‚É£ Ki·ªÉm Tra Ph√°p L√Ω & H·ªì S∆° (QUAN TR·ªåNG NH·∫§T)',
                items: [
                    { 
                        id: '0-1', 
                        title: 'ƒêi·ªÅu ki·ªán B√†n giao c·ªßa D·ª± √°n',
                        note: `<strong>Y√™u c·∫ßu CƒêT cung c·∫•p (b·∫£n g·ªëc ƒë·ªÉ ƒë·ªëi chi·∫øu v√† b·∫£n photo):</strong>
                               <ul class="list-disc pl-5">
                                   <li><strong>VƒÉn b·∫£n ch·∫•p thu·∫≠n k·∫øt qu·∫£ nghi·ªám thu</strong> c·ªßa S·ªü X√¢y d·ª±ng ƒë·ªÉ ƒë∆∞a c√¥ng tr√¨nh v√†o s·ª≠ d·ª•ng.</li>
                                   <li><strong>Bi√™n b·∫£n nghi·ªám thu ho√†n th√†nh h·∫°ng m·ª•c PCCC</strong> c·ªßa C·∫£nh s√°t PCCC.</li>
                               </ul>
                               <strong>B·∫•t l·ª£i c·∫ßn tr√°nh:</strong> Tuy·ªát ƒë·ªëi kh√¥ng nh·∫≠n nh√† n·∫øu thi·∫øu c√°c vƒÉn b·∫£n tr√™n. Vi·ªác nh·∫≠n b√†n giao khi ch∆∞a ƒë·ªß ƒëi·ªÅu ki·ªán ph√°p l√Ω s·∫Ω ƒë·∫©y r·ªßi ro v·ªÅ ph√≠a b·∫°n.
                               <span class="legal-ref"><strong>CƒÉn c·ª© ph√°p l√Ω:</strong> ƒêi·ªÅu 125 Lu·∫≠t X√¢y d·ª±ng 2014; ƒêi·ªÅu 13 Lu·∫≠t Kinh doanh BƒêS 2014; ƒêi·ªÅu 7 HƒêMB.</span>`,
                        signs: [{ id: '0-1-sign-1', text: 'CƒêT kh√¥ng cung c·∫•p ƒë·ªß gi·∫•y t·ªù', isIssue: true }],
                        symptoms: [{ id: '0-1-symptom-1', text: 'R·ªßi ro ph√°p l√Ω, kh√¥ng l√†m ƒë∆∞·ª£c s·ªï h·ªìng', isIssue: true }]
                    },
                    { 
                        id: '0-2', 
                        title: 'ƒê·ªëi chi·∫øu H·ª£p ƒë·ªìng v√† c√°c Ph·ª• l·ª•c',
                        note: `<strong>C·∫ßn chu·∫©n b·ªã:</strong> B·∫£n g·ªëc H·ª£p ƒë·ªìng mua b√°n (HƒêMB) v√† t·∫•t c·∫£ c√°c ph·ª• l·ª•c ƒë√£ k√Ω.<br>
                               <strong>L∆∞u √Ω ƒë·∫∑c bi·ªát:</strong> Ph·ª• l·ª•c 1 (Danh m·ª•c v·∫≠t li·ªáu) v√† Ph·ª• l·ª•c 2 (Ti·∫øn ƒë·ªô thanh to√°n) l√† c∆° s·ªü ƒë·ªÉ ki·ªÉm tra v√† ƒë·ªëi chi·∫øu.
                               <span class="legal-ref"><strong>CƒÉn c·ª© ph√°p l√Ω:</strong> ƒêi·ªÅu 1, Kho·∫£n 1e HƒêMB.</span>`,
                        signs: [{ id: '0-2-sign-1', text: 'Th√¥ng tin trong c√°c vƒÉn b·∫£n kh√¥ng kh·ªõp', isIssue: true }],
                        symptoms: [{ id: '0-2-symptom-1', text: 'Tranh ch·∫•p v·ªÅ sau', isIssue: true }]
                    },
                    { 
                        id: '0-3', 
                        title: 'N·ªôi dung Bi√™n b·∫£n B√†n giao',
                        note: `<strong>Tr∆∞·ªõc khi k√Ω, ph·∫£i ƒë·∫£m b·∫£o:</strong>
                               <ul class="list-disc pl-5">
                                   <li>Bi√™n b·∫£n ph·∫£i ghi ƒë√∫ng th√¥ng tin cƒÉn h·ªô, th√¥ng tin c·ªßa b·∫°n.</li>
                                   <li>M·ªçi sai s√≥t, l·ªói k·ªπ thu·∫≠t ph·∫£i ƒë∆∞·ª£c li·ªát k√™ chi ti·∫øt.</li>
                                   <li>Ph·∫£i c√≥ cam k·∫øt v·ªÅ <strong>ng√†y th√°ng c·ª• th·ªÉ</strong> kh·∫Øc ph·ª•c cho t·ª´ng l·ªói.</li>
                               </ul>
                               <strong>B·∫•t l·ª£i c·∫ßn tr√°nh:</strong> Kh√¥ng k√Ω v√†o bi√™n b·∫£n tr·ªëng ho·∫∑c bi√™n b·∫£n ghi n·ªôi dung chung chung nh∆∞ "b√†n giao ƒë√∫ng hi·ªán tr·∫°ng". M·ªçi cam k·∫øt mi·ªáng ƒë·ªÅu kh√¥ng c√≥ gi√° tr·ªã.
                               <span class="legal-ref"><strong>CƒÉn c·ª© ph√°p l√Ω:</strong> ƒêi·ªÅu 7, Kho·∫£n 4 HƒêMB.</span>`,
                        signs: [{ id: '0-3-sign-1', text: 'Bi√™n b·∫£n ghi chung chung, kh√¥ng chi ti·∫øt l·ªói', isIssue: true }],
                        symptoms: [{ id: '0-3-symptom-1', text: 'M·∫•t quy·ªÅn y√™u c·∫ßu s·ª≠a ch·ªØa', isIssue: true }]
                    }
                ]
            },
            {
                id: '1_kiem-tra-thuc-te-can-ho',
                title: '1Ô∏è‚É£ Ki·ªÉm Tra Th·ª±c T·∫ø CƒÉn H·ªô',
                items: [
                    {
                        id: '1-1', title: 'Di·ªán t√≠ch th√¥ng th·ªßy',
                        note: `<strong>Thi·∫øt b·ªã ki·ªÉm tra:</strong> th∆∞·ªõc laser, th∆∞·ªõc d√¢y.<br><span class="legal-ref"><strong>CƒÉn c·ª© ph√°p l√Ω:</strong> ƒêi·ªÅu 1, Kho·∫£n 1b HƒêMB (quy ƒë·ªãnh v·ªÅ ch√™nh l·ªách di·ªán t√≠ch +/- 1%).</span>`,
                        signs: [
                            { id: '1-1-sign-1', text: 'Sai di·ªán t√≠ch so v·ªõi h·ª£p ƒë·ªìng', isIssue: true },
                            { id: '1-1-sign-2', text: 'M√©p t∆∞·ªùng kh√¥ng vu√¥ng', isIssue: true },
                            { id: '1-1-sign-3', text: 'Chi·ªÅu d√†i/r·ªông ng·∫Øn h∆°n b·∫£n v·∫Ω', isIssue: true }
                        ],
                        symptoms: [
                            { id: '1-1-symptom-1', text: 'Kh√≥ k√™ n·ªôi th·∫•t', isIssue: true },
                            { id: '1-1-symptom-2', text: 'M·∫•t di·ªán t√≠ch s·ª≠ d·ª•ng', isIssue: true }
                        ]
                    },
                    {
                        id: '1-2', title: 'T∆∞·ªùng, tr·∫ßn, s√†n',
                        note: `<strong>Th√†nh ph·∫ßn:</strong> l·ªõp s∆°n, g·∫°ch l√°t, tr·∫ßn th·∫°ch cao.<br><span class="legal-ref"><strong>CƒÉn c·ª© ph√°p l√Ω:</strong> Ph·ª• l·ª•c 1 HƒêMB; ƒêi·ªÅu 8 HƒêMB (v·ªÅ b·∫£o h√†nh).</span>`,
                        signs: [
                            { id: '1-2-sign-1', text: 'N·ª©t ch√¢n t∆∞·ªùng, n·ª©t t∆∞·ªùng', isIssue: true },
                            { id: '1-2-sign-2', text: '·ªê m·ªëc, th·∫•m n∆∞·ªõc', isIssue: true },
                            { id: '1-2-sign-3', text: 'S∆°n ph·ªìng r·ªôp, kh√¥ng ƒë·ªÅu m√†u', isIssue: true },
                            { id: '1-2-sign-4', text: 'S√†n g·∫°ch b·ªã b·ªôp (r·ªóng), s·ª©t m·∫ª', isIssue: true }
                        ],
                        symptoms: [
                            { id: '1-2-symptom-1', text: 'Th·∫•m n∆∞·ªõc, ·∫©m m·ªëc', isIssue: true },
                            { id: '1-2-symptom-2', text: 'Bong tr√≥c s∆°n, g·∫°ch', isIssue: true },
                            { id: '1-2-symptom-3', text: 'Xu·ªëng c·∫•p nhanh, m·∫•t th·∫©m m·ªπ', isIssue: true }
                        ]
                    },
                    {
                        id: '1-3', title: 'C·ª≠a ƒëi, c·ª≠a s·ªï',
                        note: `<strong>Th√†nh ph·∫ßn:</strong> b·∫£n l·ªÅ, kho√°, k√≠nh, ron.<br><span class="legal-ref"><strong>CƒÉn c·ª© ph√°p l√Ω:</strong> Ph·ª• l·ª•c 1 HƒêMB.</span>`,
                        signs: [
                            { id: '1-3-sign-1', text: 'C·ª≠a b·ªã k·∫πt, kh√≥ ƒë√≥ng m·ªü', isIssue: true },
                            { id: '1-3-sign-2', text: 'Ron cao su b·ªã h·ªü, r√°ch', isIssue: true },
                            { id: '1-3-sign-3', text: 'K√≠nh b·ªã x∆∞·ªõc, n·ª©t', isIssue: true },
                            { id: '1-3-sign-4', text: 'B·∫£n l·ªÅ, kh√≥a b·ªã x·ªá, l·ªèng l·∫ªo', isIssue: true }
                        ],
                        symptoms: [
                            { id: '1-3-symptom-1', text: 'Kh√¥ng an to√†n, ch·ªëng tr·ªôm k√©m', isIssue: true },
                            { id: '1-3-symptom-2', text: 'Th·∫•t tho√°t nhi·ªát (m√°y l·∫°nh)', isIssue: true },
                            { id: '1-3-symptom-3', text: 'Th·∫•m n∆∞·ªõc, ·ªìn', isIssue: true }
                        ]
                    }
                ]
            },
            {
                id: '2_kiem-tra-he-thong-ky-thuat',
                title: 'üîå Ki·ªÉm Tra H·ªá Th·ªëng K·ªπ Thu·∫≠t',
                items: [
                     {
                        id: '2-1', title: 'H·ªá th·ªëng ƒëi·ªán',
                        note: `<strong>Th√†nh ph·∫ßn:</strong> CB, ·ªï c·∫Øm, c√¥ng t·∫Øc, ƒë√®n.<br><span class="legal-ref"><strong>CƒÉn c·ª© ph√°p l√Ω:</strong> Ph·ª• l·ª•c 1 HƒêMB.</span>`,
                        signs: [
                            { id: '2-1-sign-1', text: '·ªî c·∫Øm, c√¥ng t·∫Øc b·ªã l·ªèng', isIssue: true },
                            { id: '2-1-sign-2', text: 'ƒê√®n ch·ªõp nh√°y, kh√¥ng s√°ng', isIssue: true },
                            { id: '2-1-sign-3', text: 'CB nh·∫£y b·∫•t th∆∞·ªùng', isIssue: true }
                        ],
                        symptoms: [
                            { id: '2-1-symptom-1', text: 'Nguy c∆° ch·∫≠p ƒëi·ªán', isIssue: true },
                            { id: '2-1-symptom-2', text: 'Nguy c∆° ch√°y n·ªï', isIssue: true }
                        ]
                    },
                    {
                        id: '2-2', title: 'H·ªá th·ªëng c·∫•p tho√°t n∆∞·ªõc',
                        note: `<strong>Th√†nh ph·∫ßn:</strong> ƒë∆∞·ªùng ·ªëng c·∫•p, tho√°t, van, ƒë·ªìng h·ªì.<br><span class="legal-ref"><strong>CƒÉn c·ª© ph√°p l√Ω:</strong> Ph·ª• l·ª•c 1 HƒêMB; ƒêi·ªÅu 8 HƒêMB.</span>`,
                        signs: [
                            { id: '2-2-sign-1', text: 'R√≤ r·ªâ n∆∞·ªõc t·∫°i c√°c ƒë·∫ßu n·ªëi, v√≤i', isIssue: true },
                            { id: '2-2-sign-2', text: '√Åp l·ª±c n∆∞·ªõc y·∫øu', isIssue: true },
                            { id: '2-2-sign-3', text: 'Van kh√≥a b·ªã k·∫πt, kh√¥ng ho·∫°t ƒë·ªông', isIssue: true },
                            { id: '2-2-sign-4', text: 'N∆∞·ªõc tho√°t ch·∫≠m, c√≥ m√πi h√¥i', isIssue: true }
                        ],
                        symptoms: [
                            { id: '2-2-symptom-1', text: 'G√¢y ·∫©m m·ªëc t∆∞·ªùng, s√†n', isIssue: true },
                            { id: '2-2-symptom-2', text: 'TƒÉng chi ph√≠ n∆∞·ªõc b·∫•t th∆∞·ªùng', isIssue: true }
                        ]
                    },
                    {
                        id: '2-3', title: 'C·ªïng/ƒë∆∞·ªùng d√¢y l·∫Øp s·∫µn',
                        note: `<strong>Th√†nh ph·∫ßn:</strong> ƒê·∫ßu ch·ªù m√°y l·∫°nh, m√°y gi·∫∑t, b·∫øp, m·∫°ng, TV.<br><span class="legal-ref"><strong>CƒÉn c·ª© ph√°p l√Ω:</strong> Ph·ª• l·ª•c 1 HƒêMB.</span>`,
                        signs: [
                            { id: '2-3-sign-1', text: 'C·ªïng ƒëi·ªán kh√¥ng c√≥ ƒëi·ªán, sai pha', isIssue: true },
                            { id: '2-3-sign-2', text: '·ªêng ƒë·ªìng m√°y l·∫°nh b·ªã b·∫πp, g√£y', isIssue: true },
                            { id: '2-3-sign-3', text: 'ƒê·∫ßu c·∫•p n∆∞·ªõc m√°y gi·∫∑t r·ªâ n∆∞·ªõc', isIssue: true },
                            { id: '2-3-sign-4', text: '·ªêng tho√°t n∆∞·ªõc m√°y gi·∫∑t t·∫Øc', isIssue: true },
                            { id: '2-3-sign-5', text: '·ªî c·∫Øm b·∫øp b·ªã l·ªèng, n√≥ng', isIssue: true },
                            { id: '2-3-sign-6', text: 'C·ªïng m·∫°ng/TV kh√¥ng c√≥ t√≠n hi·ªáu', isIssue: true }
                        ],
                        symptoms: [
                            { id: '2-3-symptom-1', text: 'Kh√¥ng l·∫Øp ƒë∆∞·ª£c thi·∫øt b·ªã', isIssue: true },
                            { id: '2-3-symptom-2', text: 'H·ªèng thi·∫øt b·ªã (r√≤ gas, ch·∫≠p ƒëi·ªán)', isIssue: true },
                            { id: '2-3-symptom-3', text: 'Ng·∫≠p s√†n, ·∫©m m·ªëc', isIssue: true }
                        ]
                    }
                ]
            }
        ];

        const container = document.getElementById('checklist-container');
        let state = {}; 
        let customItems = {};
        let currentStream;
        let photoForItem = {};
        
        let mediaRecorder;
        let recordedChunks = [];
        let isRecording = false;
        let timerInterval;

        let currentGallery = [];
        let currentImageIndex = 0;

        function sanitizeForFilename(str) {
            if (!str) return '';
            const a = '√†√°√¢√£√®√©√™√¨√≠√≤√≥√¥√µ√π√∫ƒÉƒëƒ©≈©∆°∆∞ƒÉ·∫°·∫£·∫•·∫ß·∫©·∫´·∫≠·∫Ø·∫±·∫≥·∫µ·∫∑·∫π·∫ª·∫Ω·∫ø·ªÅ·ªÉ·ªÖ·ªá·ªâ·ªã·ªç·ªè·ªë·ªì·ªï·ªó·ªô·ªõ·ªù·ªü·ª°·ª£·ª•·ªß·ª©·ª´·ª≠·ªØ·ª±·ª≥√Ω·ªµ·ª∑·ªπ';
            const b = 'aaaaaeeeiioooouuadiuouaaaaaaaaaaaaaaaeeeeeeeeeeiiooooooooooooooooouuuuuuuuuuyyyyy';
            let result = str.toLowerCase();
            for (let i = 0; i < a.length; i++) {
                result = result.replace(new RegExp(a[i], 'g'), b[i]);
            }
            return result.replace(/[^a-z0-9_]/g, '_').replace(/_+/g, '_').replace(/^_|_$/g, '');
        }

        function renderChecklist() {
            let totalItems = 0;
            let checkedItems = 0;
            container.innerHTML = '';

            const combinedData = getCombinedData();

            const countItems = (item) => {
                if (item.isIssue) {
                    totalItems++;
                    if (state[item.id] && state[item.id].checked) {
                        checkedItems++;
                    }
                }
            };
            
            combinedData.forEach(section => {
                section.items.forEach(item => {
                    if (item.signs) item.signs.forEach(countItems);
                    if (item.symptoms) item.symptoms.forEach(countItems);
                });
            });

            combinedData.forEach(section => {
                const sectionDiv = document.createElement('details');
                sectionDiv.className = 'bg-white rounded-xl shadow-md overflow-hidden';
                sectionDiv.open = true;

                const summary = document.createElement('summary');
                summary.className = 'p-4 sm:p-5 cursor-pointer flex justify-between items-center bg-gray-50 hover:bg-gray-100 transition-colors';
                summary.innerHTML = `<h2 class="text-lg sm:text-xl font-bold text-gray-800">${section.title}</h2><svg class="w-6 h-6 text-gray-500 arrow transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>`;
                sectionDiv.appendChild(summary);

                const contentDiv = document.createElement('div');
                contentDiv.className = 'p-4 sm:p-5 border-t border-gray-200 divide-y divide-gray-200';
                
                section.items.forEach(item => {
                    contentDiv.appendChild(createChecklistGroup(section, item));
                });
                sectionDiv.appendChild(contentDiv);
                container.appendChild(sectionDiv);
            });
            updateProgress(checkedItems, totalItems);
        }
        
        function getCombinedData() {
            // Deep copy to avoid modifying the original checklistData
            const combined = JSON.parse(JSON.stringify(checklistData));
            for (const itemId in customItems) {
                const itemRef = combined.flatMap(s => s.items).find(i => i.id === itemId);
                if (itemRef) {
                    if (customItems[itemId].signs) {
                        if (!itemRef.signs) itemRef.signs = [];
                        itemRef.signs.push(...customItems[itemId].signs);
                    }
                    if (customItems[itemId].symptoms) {
                         if (!itemRef.symptoms) itemRef.symptoms = [];
                        itemRef.symptoms.push(...customItems[itemId].symptoms);
                    }
                }
            }
            return combined;
        }

        function createChecklistGroup(section, item) {
            const groupDiv = document.createElement('div');
            groupDiv.className = 'py-4';
            
            let signsHtml = '';
            if (item.signs && item.signs.length > 0) {
                signsHtml += '<h4 class="font-semibold text-gray-800 mt-3 mb-2">D·∫•u hi·ªáu:</h4>';
                item.signs.forEach(sign => {
                    signsHtml += createDetailItem(section, item, sign);
                });
            }

            let symptomsHtml = '';
            if (item.symptoms && item.symptoms.length > 0) {
                symptomsHtml += '<h4 class="font-semibold text-gray-800 mt-3 mb-2">Tri·ªáu ch·ª©ng:</h4>';
                item.symptoms.forEach(symptom => {
                    symptomsHtml += createDetailItem(section, item, symptom);
                });
            }
            
            const addSignHtml = `
                <div class="mt-2">
                    <div class="flex items-center space-x-2">
                        <input type="text" id="input-signs-${item.id}" class="w-full p-1.5 border rounded-md text-sm" placeholder="Th√™m d·∫•u hi·ªáu kh√°c...">
                        <button onclick="addCustomDetail('${item.id}', 'signs')" class="px-3 py-1.5 bg-blue-500 text-white rounded-md text-sm font-semibold hover:bg-blue-600">Th√™m</button>
                    </div>
                </div>`;
                
            const addSymptomHtml = `
                 <div class="mt-2">
                    <div class="flex items-center space-x-2">
                        <input type="text" id="input-symptoms-${item.id}" class="w-full p-1.5 border rounded-md text-sm" placeholder="Th√™m tri·ªáu ch·ª©ng kh√°c...">
                        <button onclick="addCustomDetail('${item.id}', 'symptoms')" class="px-3 py-1.5 bg-blue-500 text-white rounded-md text-sm font-semibold hover:bg-blue-600">Th√™m</button>
                    </div>
                </div>`;

            groupDiv.innerHTML = `
                <h3 class="text-lg font-bold text-gray-900">${item.title}</h3>
                ${item.note ? `<div class="note text-sm mt-2 p-3 rounded-md bg-gray-50 border-l-4 border-gray-300 text-gray-700">${item.note}</div>` : ''}
                <div class="pl-4 mt-2">
                    ${signsHtml}
                    ${addSignHtml}
                    ${symptomsHtml}
                    ${addSymptomHtml}
                </div>
            `;
            return groupDiv;
        }

        function createDetailItem(section, item, detail) {
            const itemState = state[detail.id] || { checked: false, media: [] };
            const isChecked = itemState.checked;

            let mediaSectionHtml = '<div class="mt-2 pl-8 thumbnail-container">';
            if (itemState.media && itemState.media.length > 0) {
                mediaSectionHtml += '<div class="flex flex-wrap gap-2 items-center">';
                itemState.media.forEach(mediaFile => {
                    const playIcon = mediaFile.type === 'video' ? `<div class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-20 rounded-md"><svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"></path></svg></div>` : '';
                    mediaSectionHtml += `
                        <div class="relative group">
                            <img src="${mediaFile.thumbnail}" onclick="showMediaPreview('${detail.id}', '${mediaFile.filename}')" class="h-16 w-16 rounded-lg object-cover cursor-pointer shadow-md hover:shadow-xl transition-shadow" alt="${mediaFile.filename}">
                            ${playIcon}
                            <button onclick="deleteMedia('${detail.id}', '${mediaFile.filename}')" class="delete-btn absolute -top-1 -right-1 bg-red-500 text-white rounded-full h-4 w-4 flex items-center justify-center text-xs font-bold opacity-0 group-hover:opacity-100 transition-opacity">&times;</button>
                        </div>
                    `;
                });
                mediaSectionHtml += '</div>';
            }
            mediaSectionHtml += '</div>';

            return `
                <div class="checklist-item py-2 ${isChecked ? 'checked' : ''}">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <input type="checkbox" id="${detail.id}" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500 cursor-pointer flex-shrink-0" onchange="handleCheck('${detail.id}', this.checked)" ${isChecked ? 'checked' : ''}>
                            <label for="${detail.id}" class="text-gray-800 cursor-pointer">${detail.text}</label>
                        </div>
                        <button onclick="openCameraModal('${section.id}', '${item.id}', '${detail.id}', '${detail.text}')" title="Th√™m ghi nh·∫≠n" class="p-1.5 bg-gray-100 text-gray-500 rounded-full hover:bg-gray-200">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        </button>
                    </div>
                    ${mediaSectionHtml}
                </div>
            `;
        }
        
        function addCustomDetail(itemId, type) {
            const inputId = `input-${type}-${itemId}`;
            const input = document.getElementById(inputId);
            const text = input.value.trim();
            
            if (!text) {
                alert('Vui l√≤ng nh·∫≠p n·ªôi dung.');
                return;
            }
            
            if (!customItems[itemId]) {
                customItems[itemId] = { signs: [], symptoms: [] };
            }
            if (!customItems[itemId][type]) {
                 customItems[itemId][type] = [];
            }
            
            const newDetail = {
                id: `${itemId}-custom-${type}-${Date.now()}`,
                text: text,
                isIssue: true
            };
            
            customItems[itemId][type].push(newDetail);
            localStorage.setItem('customChecklistItems', JSON.stringify(customItems));
            
            input.value = '';
            renderChecklist();
        }

        function handleCheck(id, isChecked) {
            if (!state[id]) {
                state[id] = { checked: false, media: [] };
            }
            state[id].checked = isChecked;
            localStorage.setItem('checklistState', JSON.stringify(state));
            renderChecklist();
        }
        
        function deleteMedia(detailId, filename) {
            if (state[detailId] && state[detailId].media) {
                const mediaFile = state[detailId].media.find(m => m.filename === filename);
                if (mediaFile && mediaFile.type === 'video') {
                    URL.revokeObjectURL(mediaFile.dataUrl);
                }
                state[detailId].media = state[detailId].media.filter(m => m.filename !== filename);
                localStorage.setItem('checklistState', JSON.stringify(state));
                renderChecklist();
            }
        }

        function updateProgress(checked, total) {
            const percentage = total > 0 ? Math.round((checked / total) * 100) : 0;
            document.getElementById('progress-bar').style.width = `${percentage}%`;
            document.getElementById('progress-text').textContent = `${percentage}%`;
        }
        
        function printChecklist() { window.print(); }
        
        async function downloadAllMediaAsZip() {
            const zipBtn = document.getElementById('zip-btn');
            const zipStatus = document.getElementById('zip-status');

            const allMedia = [];
            for (const detailId in state) {
                if (state[detailId].media && state[detailId].media.length > 0) {
                    allMedia.push(...state[detailId].media);
                }
            }

            if (allMedia.length === 0) {
                alert('Kh√¥ng c√≥ h√¨nh ·∫£nh/video n√†o ƒë·ªÉ t·∫£i xu·ªëng.');
                return;
            }

            zipBtn.disabled = true;
            zipBtn.classList.add('opacity-50', 'cursor-not-allowed');
            zipStatus.textContent = 'ƒêang chu·∫©n b·ªã file...';
            zipStatus.classList.remove('hidden');

            try {
                const zip = new JSZip();
                const promises = [];

                allMedia.forEach((media) => {
                    if (media.type === 'image') {
                        const base64Data = media.dataUrl.split(',')[1];
                        promises.push(Promise.resolve({ name: media.filename, data: base64Data, options: { base64: true } }));
                    } else if (media.type === 'video') {
                        const promise = fetch(media.dataUrl)
                            .then(response => response.blob())
                            .then(blob => ({ name: media.filename, data: blob, options: {} }));
                        promises.push(promise);
                    }
                });

                const files = await Promise.all(promises);
                
                files.forEach(file => {
                    zip.file(file.name, file.data, file.options);
                });

                zipStatus.textContent = 'ƒêang n√©n file ZIP...';
                const content = await zip.generateAsync({
                    type: "blob",
                    compression: "DEFLATE",
                    compressionOptions: {
                        level: 9
                    }
                }, (metadata) => {
                    zipStatus.textContent = `ƒêang n√©n: ${Math.round(metadata.percent)}%`;
                });

                const timestamp = new Date().toISOString().slice(0, 10).replace(/-/g, '');
                saveAs(content, `GoldenCity_BangChung_${timestamp}.zip`);

            } catch (error) {
                console.error("L·ªói khi t·∫°o file ZIP:", error);
                alert("ƒê√£ x·∫£y ra l·ªói khi t·∫°o file ZIP. Vui l√≤ng th·ª≠ l·∫°i.");
                zipStatus.textContent = 'ƒê√£ x·∫£y ra l·ªói!';
            } finally {
                zipBtn.disabled = false;
                zipBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                zipStatus.textContent = 'Ho√†n t·∫•t!';
                setTimeout(() => {
                    zipStatus.classList.add('hidden');
                }, 3000);
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
            if (modalId === 'image-preview-modal') {
                window.removeEventListener('keydown', handleKeyPress);
                const video = document.getElementById('preview-video');
                video.pause();
                video.src = '';
            }
        }

        async function openCameraModal(sectionId, itemId, detailId, detailText) {
            const section = checklistData.find(s => s.id === sectionId);
            const item = section.items.find(i => i.id === itemId);
           
            photoForItem = {
                sectionId: section.id,
                itemTitle: item.title,
                detailText: detailText,
                detailId: detailId
            };
            
            const cameraModal = document.getElementById('camera-modal');
            const video = document.getElementById('camera-stream');
            cameraModal.classList.remove('hidden');

            try {
                if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                    currentStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: true });
                    video.srcObject = currentStream;
                    document.getElementById('record-btn').textContent = 'B·∫Øt ƒë·∫ßu Quay';
                    isRecording = false;
                } else {
                    alert('Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ truy c·∫≠p camera.');
                    closeCamera();
                }
            } catch (err) {
                console.error("Error accessing camera: ", err);
                alert('Kh√¥ng th·ªÉ truy c·∫≠p camera. Vui l√≤ng c·∫•p quy·ªÅn v√† th·ª≠ l·∫°i.');
                closeCamera();
            }
        }
        
        function closeCamera() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
            }
            if (isRecording) {
                mediaRecorder.stop();
            }
            clearInterval(timerInterval);
            document.getElementById('timer').classList.add('hidden');
            document.getElementById('camera-modal').classList.add('hidden');
        }

        function capturePhoto() {
            const canvas = document.getElementById('camera-canvas');
            const video = document.getElementById('camera-stream');
            const context = canvas.getContext('2d');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, video.videoWidth, video.videoHeight);
            
            const dataUrl = canvas.toDataURL('image/jpeg', 0.9);
            const filename = generateFilename('jpg');
            
            saveMedia({ type: 'image', filename, dataUrl, thumbnail: dataUrl });
            
            closeCamera();
        }

        function toggleRecording() {
            const recordBtn = document.getElementById('record-btn');
            const captureBtn = document.getElementById('capture-btn');
            const timerDiv = document.getElementById('timer');

            if (!currentStream || !currentStream.active) {
                alert("L·ªói: Kh√¥ng t√¨m th·∫•y t√≠n hi·ªáu camera. Vui l√≤ng th·ª≠ m·ªü l·∫°i c·ª≠a s·ªï ghi nh·∫≠n.");
                return;
            }

            if (isRecording) {
                mediaRecorder.stop();
                recordBtn.textContent = 'B·∫Øt ƒë·∫ßu Quay';
                captureBtn.disabled = false;
                isRecording = false;
                clearInterval(timerInterval);
                timerDiv.classList.add('hidden');
            } else {
                recordedChunks = [];
                try {
                    mediaRecorder = new MediaRecorder(currentStream, { mimeType: 'video/webm' });
                } catch (e) {
                    console.error("Error creating MediaRecorder:", e);
                    alert("Kh√¥ng th·ªÉ t·∫°o tr√¨nh ghi video. Tr√¨nh duy·ªát c·ªßa b·∫°n c√≥ th·ªÉ kh√¥ng h·ªó tr·ª£ ƒë·ªãnh d·∫°ng n√†y.");
                    return;
                }

                mediaRecorder.ondataavailable = event => {
                    if (event.data.size > 0) {
                        recordedChunks.push(event.data);
                    }
                };
                mediaRecorder.onstop = () => {
                    const blob = new Blob(recordedChunks, { type: 'video/webm' });
                    const videoUrl = URL.createObjectURL(blob);
                    
                    const video = document.createElement('video');
                    video.src = videoUrl;
                    video.onloadeddata = () => {
                        const canvas = document.getElementById('camera-canvas');
                        canvas.width = video.videoWidth;
                        canvas.height = video.videoHeight;
                        canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
                        const thumbnailUrl = canvas.toDataURL('image/jpeg');
                        
                        const filename = generateFilename('webm');
                        saveMedia({ type: 'video', filename, dataUrl: videoUrl, thumbnail: thumbnailUrl });
                        
                        closeCamera();
                    };
                };

                mediaRecorder.start();
                recordBtn.textContent = 'D·ª´ng Quay';
                captureBtn.disabled = true;
                isRecording = true;
                
                let seconds = 0;
                timerDiv.classList.remove('hidden');
                timerDiv.textContent = '00:00';
                timerInterval = setInterval(() => {
                    seconds++;
                    const min = Math.floor(seconds / 60).toString().padStart(2, '0');
                    const sec = (seconds % 60).toString().padStart(2, '0');
                    timerDiv.textContent = `${min}:${sec}`;
                }, 1000);
            }
        }
        
        function generateFilename(extension) {
            const sectionName = sanitizeForFilename(photoForItem.sectionId);
            const itemName = sanitizeForFilename(photoForItem.itemTitle);
            const detailName = sanitizeForFilename(photoForItem.detailText);
            return `${sectionName}_${itemName}_${detailName}.${extension}`;
        }
        
        function saveMedia(mediaObject) {
            const detailId = photoForItem.detailId;
            if (!state[detailId]) {
                state[detailId] = { checked: false, media: [] };
            }
            state[detailId].media.push(mediaObject);
            localStorage.setItem('checklistState', JSON.stringify(state));
            renderChecklist();
        }

        function showMediaPreview(detailId, filename) {
            const itemState = state[detailId];
            if (!itemState || !itemState.media || itemState.media.length === 0) return;
            currentGallery = itemState.media;
            currentImageIndex = currentGallery.findIndex(m => m.filename === filename);
            if (currentImageIndex === -1) return;
            
            document.getElementById('image-preview-modal').classList.remove('hidden');
            window.addEventListener('keydown', handleKeyPress);
            updatePreviewContent();
        }

        function updatePreviewContent() {
            if (currentGallery.length === 0) {
                closeModal('image-preview-modal');
                return;
            }
            if (currentImageIndex < 0) currentImageIndex = 0;
            if (currentImageIndex >= currentGallery.length) currentImageIndex = currentGallery.length - 1;

            const mediaFile = currentGallery[currentImageIndex];
            const previewImage = document.getElementById('preview-image');
            const previewVideo = document.getElementById('preview-video');
            const galleryThumbs = document.getElementById('gallery-thumbnails');

            galleryThumbs.innerHTML = '';
            currentGallery.forEach((file, index) => {
                const playIcon = file.type === 'video' ? `<div class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-30"><svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20"><path d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z"></path></svg></div>` : '';
                const thumbDiv = document.createElement('div');
                thumbDiv.className = `gallery-thumbnail relative h-16 w-16 rounded-md cursor-pointer border-2 ${index === currentImageIndex ? 'border-blue-500' : 'border-transparent'}`;
                thumbDiv.innerHTML = `<img src="${file.thumbnail}" class="h-full w-full object-cover rounded-md">${playIcon}`;
                thumbDiv.onclick = () => {
                    currentImageIndex = index;
                    updatePreviewContent();
                };
                galleryThumbs.appendChild(thumbDiv);
            });


            if (mediaFile.type === 'image') {
                previewImage.src = mediaFile.dataUrl;
                previewImage.classList.remove('hidden');
                previewVideo.classList.add('hidden');
                previewVideo.pause();
                previewVideo.src = '';
            } else { 
                previewVideo.src = mediaFile.dataUrl;
                previewVideo.classList.remove('hidden');
                previewImage.classList.add('hidden');
                previewImage.src = '';
            }

            const prevBtn = document.getElementById('prev-image-btn');
            const nextBtn = document.getElementById('next-image-btn');

            if (currentGallery.length > 1) {
                prevBtn.classList.remove('hidden');
                nextBtn.classList.remove('hidden');
                prevBtn.disabled = currentImageIndex === 0;
                nextBtn.disabled = currentImageIndex === currentGallery.length - 1;
            } else {
                prevBtn.classList.add('hidden');
                nextBtn.classList.add('hidden');
            }
        }
        
        function navigateGallery(direction) {
            const newIndex = currentImageIndex + direction;
            if (newIndex >= 0 && newIndex < currentGallery.length) {
                currentImageIndex = newIndex;
                updatePreviewContent();
            }
        }
        
        function handleKeyPress(event) {
            if (event.key === 'ArrowLeft') {
                navigateGallery(-1);
            } else if (event.key === 'ArrowRight') {
                navigateGallery(1);
            } else if (event.key === 'Escape') {
                closeModal('image-preview-modal');
            }
        }

        function openDraftEmailModal() {
            const issuesListDiv = document.getElementById('issues-list');
            issuesListDiv.innerHTML = '';
            const detectedIssues = [];

            const findIssues = (detail) => {
                if (state[detail.id] && state[detail.id].checked) {
                    // Prevent duplicates
                    if (!detectedIssues.some(issue => issue.id === detail.id)) {
                        detectedIssues.push({id: detail.id, text: detail.text});
                    }
                }
            };
            getCombinedData().forEach(section => {
                section.items.forEach(item => {
                    if(item.signs) item.signs.forEach(findIssues);
                    if(item.symptoms) item.symptoms.forEach(findIssues);
                });
            });
            
            detectedIssues.forEach(issue => {
                issuesListDiv.innerHTML += `<label class="flex items-center space-x-3"><input type="checkbox" name="issue" value="${issue.text}" class="form-checkbox h-5 w-5 text-blue-600" checked><span class="text-gray-700">${issue.text}</span></label>`;
            });
            
            document.getElementById('gemini-modal').classList.remove('hidden');
            document.getElementById('gemini-result-container').classList.add('hidden');
            document.getElementById('gemini-loader').classList.add('hidden');
        }

        async function generateEmail() {
            const selectedIssuesNodes = document.querySelectorAll('input[name="issue"]:checked');
            const selectedIssues = Array.from(selectedIssuesNodes).map(node => node.value);
            const customIssue = document.getElementById('custom-issue').value;
            if (selectedIssues.length === 0 && !customIssue) {
                alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt v·∫•n ƒë·ªÅ ho·∫∑c nh·∫≠p y√™u c·∫ßu c·ªßa b·∫°n.');
                return;
            }
            const loader = document.getElementById('gemini-loader');
            const resultContainer = document.getElementById('gemini-result-container');
            const resultDiv = document.getElementById('gemini-result');
            loader.classList.remove('hidden');
            resultContainer.classList.add('hidden');
            let prompt = `B·∫°n l√† m·ªôt tr·ª£ l√Ω ph√°p l√Ω cho ng∆∞·ªùi mua nh√† ·ªü x√£ h·ªôi t·∫°i Vi·ªát Nam. H√£y so·∫°n m·ªôt vƒÉn b·∫£n (d·∫°ng ƒë∆°n khi·∫øu n·∫°i ho·∫∑c email) trang tr·ªçng, l·ªãch s·ª± nh∆∞ng ki√™n quy·∫øt ƒë·ªÉ g·ª≠i cho Ch·ªß ƒë·∫ßu t∆∞ d·ª± √°n Nh√† ·ªü x√£ h·ªôi Golden City An Giang. N·ªôi dung c·∫ßn ƒë·ªÅ c·∫≠p c√°c v·∫•n ƒë·ªÅ sau:\n\n`;
            selectedIssues.forEach(issue => { prompt += `- ${issue}\n`; });
            if(customIssue) { prompt += `- V·∫•n ƒë·ªÅ b·ªï sung: ${customIssue}\n`; }
            prompt += `\nVƒÉn b·∫£n c·∫ßn y√™u c·∫ßu Ch·ªß ƒë·∫ßu t∆∞ ph·∫£n h·ªìi v·ªÅ l·ªô tr√¨nh kh·∫Øc ph·ª•c c√°c v·∫•n ƒë·ªÅ tr√™n v√† th·ª±c hi·ªán nghƒ©a v·ª• b·ªìi th∆∞·ªùng ch·∫≠m b√†n giao theo h·ª£p ƒë·ªìng. Cu·ªëi th∆∞, h√£y ghi r√µ th√¥ng tin ng∆∞·ªùi g·ª≠i l√† "ƒê·∫°i di·ªán c√°c h·ªô d√¢n mua nh√† t·∫°i t√≤a T3, T4" v√† ƒë·ªÉ tr·ªëng ph·∫ßn k√Ω t√™n.`;
            
            try {
                let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                const payload = { contents: chatHistory };
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) { throw new Error(`API call failed with status: ${response.status}`); }
                const result = await response.json();
                if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts) {
                    const text = result.candidates[0].content.parts[0].text;
                    resultDiv.innerHTML = text.replace(/\n/g, '<br>');
                } else {
                   resultDiv.innerText = 'R·∫•t ti·∫øc, ƒë√£ c√≥ l·ªói x·∫£y ra. Kh√¥ng nh·∫≠n ƒë∆∞·ª£c ph·∫£n h·ªìi h·ª£p l·ªá t·ª´ AI. Vui l√≤ng th·ª≠ l·∫°i.';
                }
            } catch (error) {
                 resultDiv.innerText = `ƒê√£ x·∫£y ra l·ªói khi k·∫øt n·ªëi ƒë·∫øn Gemini AI. Vui l√≤ng ki·ªÉm tra l·∫°i. L·ªói: ${error.message}`;
            } finally {
                loader.classList.add('hidden');
                resultContainer.classList.remove('hidden');
            }
        }
        
        function copyToClipboard() {
            const textToCopy = document.getElementById('gemini-result').innerText;
            const tempTextArea = document.createElement('textarea');
            tempTextArea.value = textToCopy;
            document.body.appendChild(tempTextArea);
            tempTextArea.select();
            document.execCommand('copy');
            document.body.removeChild(tempTextArea);
            alert('ƒê√£ sao ch√©p n·ªôi dung v√†o b·ªô nh·ªõ t·∫°m!');
        }

        // Scroll-based collapse for progress bar
        let lastScrollY = window.scrollY;
        const stickyPanel = document.querySelector('.sticky-progress');

        window.addEventListener('scroll', () => {
            const currentScrollY = window.scrollY;

            // Add a small threshold to prevent flickering at the top
            if (currentScrollY > lastScrollY && currentScrollY > 100) { 
                stickyPanel.classList.add('collapsed');
            } else if (currentScrollY < lastScrollY) {
                stickyPanel.classList.remove('collapsed');
            }

            lastScrollY = currentScrollY <= 0 ? 0 : currentScrollY;
        });

        // Initial Load
        const savedState = localStorage.getItem('checklistState');
        if (savedState) { state = JSON.parse(savedState); }
        const savedCustomItems = localStorage.getItem('customChecklistItems');
        if(savedCustomItems) { customItems = JSON.parse(savedCustomItems); }
        
        renderChecklist();
    </script>

</body>
</html>
